@using MIMM.Shared.Dtos
@using MIMM.Frontend.Services
@using MIMM.Frontend.Models
@using MudBlazor
@inject IEntryApiService EntryApi
@inject ISnackbar Snackbar

<MudDialog aria-modal="true" role="dialog">
    <DialogContent>
        <div tabindex="0" @onfocus="FocusFirstAsync" class="sr-only"></div>
        <MudTabs Elevation="0" ApplyEffectsToContainer="true">
            <!-- Tab 1: Music Search -->
            <MudTabPanel Text="Music">
                <MudStack Spacing="3" Class="pa-3">
                    <MudText Typo="Typo.body1">Find and select a track</MudText>

                    <MusicSearchBox OnTrackSelected="@HandleTrackSelected" />

                    @if (_selectedTrack is not null)
                    {
                        <MudPaper Class="pa-3" Elevation="0" Style="background-color:rgba(33,150,243,0.15); border-left:4px solid #2196F3;">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                @if (!string.IsNullOrEmpty(_selectedTrack.CoverUrl))
                                {
                                    <MudAvatar src="@_selectedTrack.CoverUrl" Size="Size.Large" Class="rounded" />
                                }
                                else
                                {
                                    <MudAvatar Color="Color.Primary" Size="Size.Large">
                                        <MudIcon Icon="@Icons.Material.Filled.MusicNote" />
                                    </MudAvatar>
                                }
                                
                                <MudStack Spacing="0" Style="flex:1;">
                                    <MudText Typo="Typo.body1" Style="font-weight:500;">@_selectedTrack.Title</MudText>
                                    <MudText Typo="Typo.body2">@_selectedTrack.Artist</MudText>
                                    @if (!string.IsNullOrEmpty(_selectedTrack.Album))
                                    {
                                        <MudText Typo="Typo.caption">@_selectedTrack.Album</MudText>
                                    }
                                </MudStack>
                                <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="@ClearTrackSelection" Color="Color.Default" Size="Size.Small" />
                            </MudStack>
                        </MudPaper>
                    }
                    else
                    {
                        <MudText Typo="Typo.caption">Or enter music manually</MudText>
                        <MudStack Spacing="2">
                            <MudTextField @bind-Value="Model.SongTitle" Label="Song title *" Required RequiredError="Song title is required" />
                            <MudTextField @bind-Value="Model.ArtistName" Label="Artist (optional)" />
                            <MudTextField @bind-Value="Model.AlbumName" Label="Album (optional)" />
                        </MudStack>
                    }
                </MudStack>
            </MudTabPanel>

            <!-- Tab 2: Mood & Tension -->
            <MudTabPanel Text="Mood">
                <MudStack Spacing="3" Class="pa-3">
                    <MudText Typo="Typo.body1">How were you feeling?</MudText>

                    <MoodSelector2D @bind-Valence="Model.Valence" @bind-Arousal="Model.Arousal" Size="200" />

                    <MudStack Spacing="2">
                        <MudText Typo="Typo.subtitle2">Physical Tension</MudText>
                        <MudSlider @bind-Value="Model.TensionLevel" 
                                   Min="0" 
                                   Max="100" 
                                   Step="5" />
                        <MudText Typo="Typo.caption">0 = Relaxed • 50 = Neutral • 100 = Tense</MudText>
                    </MudStack>
                </MudStack>
            </MudTabPanel>

            <!-- Tab 3: Tags & Notes -->
            <MudTabPanel Text="Tags & Notes">
                <MudStack Spacing="3" Class="pa-3">
                    <MudText Typo="Typo.body1">Add context and details</MudText>

                    <div>
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Somatic Tags</MudText>
                        <MudStack Row Wrap="Wrap.Wrap" Spacing="1">
                            @foreach (var tag in CommonSomaticTags)
                            {
                                <MudButton Variant="@(_selectedTags.Contains(tag) ? Variant.Filled : Variant.Outlined)"
                                           Color="@(_selectedTags.Contains(tag) ? Color.Primary : Color.Default)"
                                           Size="Size.Small"
                                           OnClick="@(() => ToggleTag(tag))">
                                    @tag
                                </MudButton>
                            }
                        </MudStack>
                    </div>

                    <MudTextField @bind-Value="_customTag" 
                                  Label="Add custom tag" 
                                  Placeholder="Press Enter to add"
                                  OnKeyDown="@OnCustomTagKeyDown" 
                                  Clearable />

                    <MudTextField @bind-Value="Model.Notes" 
                                  Label="Notes (optional)" 
                                  Lines="4" 
                                  MaxLength="2000"
                                  Counter="2000"
                                  Placeholder="How did this music affect your mood?" />
                </MudStack>
            </MudTabPanel>
        </MudTabs>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@CancelDialog" ButtonType="ButtonType.Button" @ref="_firstFocusable">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   OnClick="SubmitAsync" 
                   Disabled="@(!IsFormValid || _isSubmitting)"
                   ButtonType="ButtonType.Button">
            @if (_isSubmitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate Class="mr-2" />
            }
            Create Entry
        </MudButton>
        <div tabindex="0" @onfocus="FocusFirstAsync" class="sr-only"></div>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public EventCallback OnEntryCreated { get; set; }

    private bool _isSubmitting;
    private bool _hasFocused;
    private MusicTrackDto? _selectedTrack;
    private string _customTag = string.Empty;
    private MudButton? _firstFocusable;

    private CreateEntryModel Model { get; set; } = new()
    {
        Valence = 0,
        Arousal = 0,
        TensionLevel = 50
    };

    private HashSet<string> _selectedTags = [];

    private static readonly string[] CommonSomaticTags =
    [
        "Relaxed", "Tense", "Energetic", "Tired", 
        "Warm", "Cold", "Tingling", "Heavy", 
        "Light", "Grounded", "Floating", "Centered"
    ];

    private bool IsFormValid => !string.IsNullOrWhiteSpace(Model.SongTitle);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_hasFocused)
        {
            _hasFocused = true;
            await FocusFirstAsync();
        }
    }

    private async Task FocusFirstAsync()
    {
        if (_firstFocusable is not null)
        {
            await _firstFocusable.FocusAsync();
        }
    }

    private void ToggleTag(string tag)
    {
        if (_selectedTags.Contains(tag))
        {
            _selectedTags.Remove(tag);
        }
        else
        {
            _selectedTags.Add(tag);
        }
        StateHasChanged();
    }

    private void ClearTrackSelection()
    {
        _selectedTrack = null;
        Model.SongTitle = string.Empty;
        Model.ArtistName = string.Empty;
        Model.AlbumName = string.Empty;
        StateHasChanged();
    }

    private void HandleTrackSelected(MusicTrackDto track)
    {
        _selectedTrack = track;
        Model.SongTitle = track.Title;
        Model.ArtistName = track.Artist;
        Model.AlbumName = track.Album;
        Model.CoverUrl = track.CoverUrl;
        Model.SongId = track.ExternalId;
        Model.Source = track.Source;
        StateHasChanged();
    }

    private void OnCustomTagKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            if (!string.IsNullOrWhiteSpace(_customTag))
            {
                _selectedTags.Add(_customTag.Trim());
                _customTag = string.Empty;
                StateHasChanged();
            }
        }
    }

    private void CancelDialog()
    {
        MudDialog.Cancel();
    }

    private async Task SubmitAsync()
    {
        if (string.IsNullOrWhiteSpace(Model.SongTitle))
        {
            Snackbar.Add("Song title is required", Severity.Warning);
            return;
        }

        _isSubmitting = true;

        try
        {
            var request = new CreateEntryRequest
            {
                SongTitle = Model.SongTitle,
                ArtistName = Model.ArtistName,
                AlbumName = Model.AlbumName,
                CoverUrl = _selectedTrack?.CoverUrl ?? Model.CoverUrl,
                SongId = _selectedTrack?.ExternalId,
                Source = _selectedTrack?.Source ?? "manual",
                Valence = Model.Valence,
                Arousal = Model.Arousal,
                TensionLevel = Model.TensionLevel,
                SomaticTags = [.._selectedTags],
                Notes = Model.Notes
            };

            var result = await EntryApi.CreateEntryAsync(request);

            if (result != null)
            {
                Snackbar.Add("Entry created successfully", Severity.Success);
                await OnEntryCreated.InvokeAsync();
                MudDialog.Close(DialogResult.Ok(result));
            }
            else
            {
                Snackbar.Add("Failed to create entry", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}
