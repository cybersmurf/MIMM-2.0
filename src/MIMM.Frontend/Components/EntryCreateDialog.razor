@using MIMM.Shared.Dtos
@using MIMM.Frontend.Services
@using MIMM.Frontend.Models
@inject IEntryApiService EntryApi
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_isFormValid">
            <MudStack Spacing="3">
                <MudTextField @bind-Value="Model.SongTitle" 
                              Label="Song title *" 
                              Required 
                              RequiredError="Song title is required" />

                <MudTextField @bind-Value="Model.ArtistName" Label="Artist" />

                <MudTextField @bind-Value="Model.AlbumName" Label="Album" />

                <MudPaper Class="pa-3" Elevation="0" Style="background-color:rgba(0,0,0,0.02);">
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.subtitle2">Find a track</MudText>

                        @if (_selectedTrack is not null)
                        {
                            <MudChip Color="Color.Primary" Variant="Variant.Filled" Class="mb-1">
                                Selected: @_selectedTrack.Title â€” @_selectedTrack.Artist (@_selectedTrack.Album)
                            </MudChip>
                        }

                        <MusicSearchBox OnTrackSelected="HandleTrackSelected" />
                    </MudStack>
                </MudPaper>

                <MudDivider Class="my-2" />

                <MoodSelector2D @bind-Valence="Model.Valence"
                                 @bind-Arousal="Model.Arousal" />

                <MudStack Spacing="2">
                    <MudText Typo="Typo.body2">Tension level: @Model.TensionLevel</MudText>
                    <MudSlider @bind-Value="Model.TensionLevel" 
                               Min="0" 
                               Max="100" 
                               Step="5" 
                               Color="Color.Tertiary" />
                </MudStack>

                <MudDivider Class="my-2" />

                <MudText Typo="Typo.subtitle2">Somatic tags (optional)</MudText>
                <MudStack Row Wrap="Wrap.Wrap" Spacing="1">
                    @foreach (var tag in CommonSomaticTags)
                    {
                        <MudChip T="string" Size="Size.Small" 
                                 Color="@(SelectedTags.Contains(tag) ? Color.Primary : Color.Default)"
                                 Variant="@(SelectedTags.Contains(tag) ? Variant.Filled : Variant.Outlined)"
                                 OnClick="@(() => ToggleTag(tag))">
                            @tag
                        </MudChip>
                    }
                </MudStack>

                <MudTextField @bind-Value="CustomTag" 
                              Label="Add custom tag" 
                              Adornment="Adornment.End" 
                              AdornmentIcon="@Icons.Material.Filled.Add"
                              OnAdornmentClick="AddCustomTag" 
                              OnKeyDown="OnCustomTagKeyDown" />

                <MudTextField @bind-Value="Model.Notes" 
                              Label="Notes (optional)" 
                              Lines="4" 
                              MaxLength="2000"
                              Counter="2000" />
            </MudStack>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   OnClick="SubmitAsync" 
                   Disabled="@(!_isFormValid || _isSubmitting)">
            @if (_isSubmitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate Class="mr-2" />
            }
            Create entry
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public EventCallback OnEntryCreated { get; set; }

    private MudForm _form = null!;
    private bool _isFormValid;
    private bool _isSubmitting;
    private MusicTrackDto? _selectedTrack;

    private CreateEntryModel Model { get; set; } = new()
    {
        Valence = 0,
        Arousal = 0,
        TensionLevel = 50
    };

    private HashSet<string> SelectedTags { get; set; } = [];
    private string CustomTag { get; set; } = string.Empty;

    private static readonly string[] CommonSomaticTags =
    [
        "Relaxed", "Tense", "Energetic", "Tired", 
        "Warm", "Cold", "Tingling", "Heavy", 
        "Light", "Grounded", "Floating", "Centered"
    ];

    private void ToggleTag(string tag)
    {
        if (SelectedTags.Contains(tag))
        {
            SelectedTags.Remove(tag);
        }
        else
        {
            SelectedTags.Add(tag);
        }
    }

    private void AddCustomTag()
    {
        if (!string.IsNullOrWhiteSpace(CustomTag))
        {
            SelectedTags.Add(CustomTag.Trim());
            CustomTag = string.Empty;
        }
    }

    private void OnCustomTagKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            AddCustomTag();
        }
    }

    private void HandleTrackSelected(MusicTrackDto track)
    {
        _selectedTrack = track;
        Model.SongTitle = track.Title;
        Model.ArtistName = track.Artist;
        Model.AlbumName = track.Album;
        Model.CoverUrl = track.CoverUrl;
        StateHasChanged();
    }

    private async Task SubmitAsync()
    {
        await _form.Validate();

        if (!_isFormValid)
        {
            return;
        }

        _isSubmitting = true;

        try
        {
            var request = new CreateEntryRequest
            {
                SongTitle = Model.SongTitle,
                ArtistName = Model.ArtistName,
                AlbumName = Model.AlbumName,
                CoverUrl = _selectedTrack?.CoverUrl ?? Model.CoverUrl,
                SongId = _selectedTrack?.ExternalId,
                Source = _selectedTrack?.Source ?? "manual",
                Valence = Model.Valence,
                Arousal = Model.Arousal,
                TensionLevel = Model.TensionLevel,
                SomaticTags = [.. SelectedTags],
                Notes = Model.Notes
            };

            var result = await EntryApi.CreateEntryAsync(request);

            if (result != null)
            {
                Snackbar.Add("Entry created successfully", Severity.Success);
                await OnEntryCreated.InvokeAsync();
                MudDialog.Close(DialogResult.Ok(result));
            }
            else
            {
                Snackbar.Add("Failed to create entry", Severity.Error);
            }
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
