@using MIMM.Shared.Dtos
@using MIMM.Frontend.Services
@inject IEntryApiService EntryApi
@inject ISnackbar Snackbar

<MudPaper Elevation="2" Class="pa-4">
    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
        <MudText Typo="Typo.h6">Recent entries</MudText>
        <MudSpacer />
        @if (IsLoading)
        {
            <MudProgressCircular Size="Size.Small" Indeterminate />
        }
        else
        {
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" OnClick="LoadEntriesAsync" />
        }
    </MudStack>

    @if (IsLoading && Entries.Count == 0)
    {
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="60px" Class="mb-2" />
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="60px" Class="mb-2" />
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="60px" />
    }
    else if (Entries.Count == 0)
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
            No entries yet. Create your first mood log!
        </MudAlert>
    }
    else
    {
        <MudList T="string" Dense>
            @foreach (var entry in Entries)
            {
                <MudListItem T="string">
                    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                        @if (!string.IsNullOrEmpty(entry.CoverUrl))
                        {
                            <MudAvatar Src="@entry.CoverUrl" Size="Size.Medium" Class="rounded" />
                        }
                        else
                        {
                            <MudAvatar Color="Color.Primary" Size="Size.Medium">
                                <MudIcon Icon="@Icons.Material.Filled.MusicNote" />
                            </MudAvatar>
                        }
                        
                        <MudStack Spacing="0" Style="flex: 1;">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                <MudText Typo="Typo.body1">@entry.SongTitle</MudText>
                                @if (!string.IsNullOrWhiteSpace(entry.SongId))
                                {
                                    <MudTooltip Text="@($"MusicBrainz ID: {entry.SongId}")" Arrow ShowOnHover Duration="500">
                                        <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Color="Color.Secondary" />
                                    </MudTooltip>
                                }
                            </MudStack>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @(entry.ArtistName ?? "Unknown artist") â€¢ @entry.CreatedAt.ToString("MMM d, HH:mm")
                            </MudText>
                            @if (!string.IsNullOrWhiteSpace(entry.AlbumName))
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Album: @entry.AlbumName</MudText>
                            }
                        </MudStack>

                        <MudStack Row Spacing="1">
                            <MudChip T="string" Size="Size.Small" Color="@GetSourceColor(entry.Source)" Variant="Variant.Outlined">
                                @GetSourceBadge(entry.Source)
                            </MudChip>

                            <MudChip T="string" Size="Size.Small" Color="@GetMoodColor(entry.Valence)">
                                @GetMoodLabel(entry.Valence, entry.Arousal)
                            </MudChip>

                            @if (!string.IsNullOrWhiteSpace(entry.SongId))
                            {
                                <MudTooltip Text="@($"MusicBrainz ID: {entry.SongId}")" Arrow ShowOnHover Duration="500">
                                    <MudChip T="string" Size="Size.Small" Color="Color.Tertiary" Icon="@Icons.Material.Filled.MusicNote" Variant="Variant.Filled">
                                        MB
                                    </MudChip>
                                </MudTooltip>
                            }
                        </MudStack>

                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                       Size="Size.Small" 
                                       OnClick="@(() => OnEditEntry.InvokeAsync(entry))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                       Size="Size.Small" 
                                       Color="Color.Error"
                                       OnClick="@(() => HandleDeleteAsync(entry.Id))" />
                    </MudStack>
                </MudListItem>
                <MudDivider />
            }
        </MudList>

        @if (PagedResponse != null && PagedResponse.TotalPages > 1)
        {
            <MudPagination Class="mt-3" 
                           Count="@PagedResponse.TotalPages" 
                           Selected="@PagedResponse.PageNumber" 
                           SelectedChanged="OnPageChangedAsync" 
                           ShowFirstButton 
                           ShowLastButton />
        }
    }
</MudPaper>

@code {
    [Parameter]
    public EventCallback<EntryDto> OnEditEntry { get; set; }

    [Parameter]
    public EventCallback OnEntryChanged { get; set; }

    private List<EntryDto> Entries { get; set; } = new();
    private PagedResponse<EntryDto>? PagedResponse { get; set; }
    private bool IsLoading { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadEntriesAsync();
    }

    public async Task LoadEntriesAsync()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            var request = new PaginationRequest
            {
                PageNumber = 1,
                PageSize = 10,
                SortBy = "created",
                SortDirection = "desc"
            };

            PagedResponse = await EntryApi.GetEntriesAsync(request);

            if (PagedResponse != null)
            {
                Entries = PagedResponse.Items;
            }
            else
            {
                Snackbar.Add("Failed to load entries", Severity.Error);
            }
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnPageChangedAsync(int page)
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            var request = new PaginationRequest
            {
                PageNumber = page,
                PageSize = 10,
                SortBy = "created",
                SortDirection = "desc"
            };

            PagedResponse = await EntryApi.GetEntriesAsync(request);

            if (PagedResponse != null)
            {
                Entries = PagedResponse.Items;
            }
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleDeleteAsync(Guid id)
    {
        var success = await EntryApi.DeleteEntryAsync(id);

        if (success)
        {
            Snackbar.Add("Entry deleted", Severity.Success);
            await LoadEntriesAsync();
            await OnEntryChanged.InvokeAsync();
        }
        else
        {
            Snackbar.Add("Failed to delete entry", Severity.Error);
        }
    }

    private Color GetMoodColor(double valence)
    {
        return valence switch
        {
            > 0.3 => Color.Success,
            < -0.3 => Color.Error,
            _ => Color.Warning
        };
    }

    private Color GetSourceColor(string source)
    {
        return source?.ToLowerInvariant() switch
        {
            "itunes" => Color.Info,
            "lastfm" => Color.Secondary,
            "deezer" => Color.Tertiary,
            _ => Color.Dark
        };
    }

    private string GetMoodLabel(double valence, double arousal)
    {
        return (valence, arousal) switch
        {
            ( > 0.3, > 0.3) => "Happy",
            ( > 0.3, < -0.3) => "Calm",
            ( < -0.3, > 0.3) => "Angry",
            ( < -0.3, < -0.3) => "Sad",
            _ => "Neutral"
        };
    }

    private string GetSourceBadge(string source)
    {
        return source?.ToLowerInvariant() switch
        {
            "musicbrainz" => "ðŸŽµ MB",
            "itunes" => "ðŸŽµ iTunes",
            "lastfm" => "ðŸŽµ Last.fm",
            "deezer" => "ðŸŽµ Deezer",
            "manual" => "âœï¸ Manual",
            _ => source ?? "Unknown"
        };
    }
}
