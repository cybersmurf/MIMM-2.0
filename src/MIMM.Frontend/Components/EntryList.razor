@using MIMM.Shared.Dtos
@using MIMM.Frontend.Services
@inject IEntryApiService EntryApi
@inject ILastFmApiService LastFmApi
@inject ISnackbar Snackbar

<LiveRegion Message="@_liveMessage" AriaLive="polite" />

<MudPaper Elevation="2" Class="pa-4">
    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
        <MudText Typo="Typo.h6">Recent entries</MudText>
        <MudSpacer />
        @if (IsLoading)
        {
            <MudProgressCircular Size="Size.Small" Indeterminate />
        }
        else
        {
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                           Size="Size.Small" 
                           Style="min-height: 44px; min-width: 44px;"
                           OnClick="LoadEntriesAsync" />
        }
    </MudStack>

    @if (IsLoading && Entries.Count == 0)
    {
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="60px" Class="mb-2 skeleton-shimmer" />
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="60px" Class="mb-2 skeleton-shimmer" />
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="60px" Class="skeleton-shimmer" />
    }
    else if (Entries.Count == 0)
    {
        <MudStack AlignItems="AlignItems.Center" Spacing="3" Class="pa-8 animate-fade-in-up">
            <MudIcon Icon="@Icons.Material.Filled.MusicNote" 
                     Color="Color.Primary" 
                     Style="font-size: 120px; opacity: 0.5;" />
            
            <MudText Typo="Typo.h5" Align="Align.Center">
                No entries yet
            </MudText>
            
            <MudText Typo="Typo.body1" Align="Align.Center">
                Start tracking your mood and music journey.<br />
                Your first entry is just a click away!
            </MudText>
            
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       Size="Size.Large"
                       Class="btn-hover-lift"
                       StartIcon="@Icons.Material.Filled.AddCircle"
                       OnClick="@(() => OnCreateFirstEntry.InvokeAsync())">
                Create Your First Entry
            </MudButton>
        </MudStack>
    }
    else
    {
        <MudList T="string" Dense>
            @foreach (var entry in Entries)
            {
                <MudListItem T="string" Class="list-item-stagger transition-colors">
                    <MudStack Spacing="2">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                            @if (!string.IsNullOrEmpty(entry.CoverUrl))
                            {
                                <MudAvatar src="@entry.CoverUrl" Size="Size.Medium" Class="rounded" />
                            }
                            else
                            {
                                <MudAvatar Color="Color.Primary" Size="Size.Medium">
                                    <MudIcon Icon="@Icons.Material.Filled.MusicNote" />
                                </MudAvatar>
                            }
                            
                            <MudStack Spacing="0" Style="flex: 1; min-width: 0;">
                                <MudText Typo="Typo.body1" Style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    @entry.SongTitle
                                </MudText>
                                <MudText Typo="Typo.body2">
                                    @(entry.ArtistName ?? "Unknown artist") â€¢ @entry.CreatedAt.ToString("MMM d, HH:mm")
                                </MudText>
                                @if (!string.IsNullOrWhiteSpace(entry.AlbumName))
                                {
                                    <MudText Typo="Typo.caption">Album: @entry.AlbumName</MudText>
                                }
                            </MudStack>
                        </MudStack>
                        
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="1" Style="flex-wrap: wrap; gap: 4px;">
                            <MudChip T="string" Size="Size.Small" Color="@GetSourceColor(entry.Source)" Variant="Variant.Filled">
                                @GetSourceBadge(entry.Source)
                            </MudChip>

                                <MudChip T="string" Size="Size.Small" Color="@GetMoodColor(entry.Valence)">
                                    Mood: @GetMoodLabel(entry.Valence, entry.Arousal)
                                </MudChip>

                            @if (!string.IsNullOrWhiteSpace(entry.SongId))
                            {
                                <MudTooltip Text="@($"MusicBrainz ID: {entry.SongId}")" Arrow ShowOnHover Duration="500">
                                        <MudChip T="string" Size="Size.Small" Color="Color.Tertiary" Icon="@Icons.Material.Filled.MusicNote" Variant="Variant.Filled">
                                            MB ID
                                        </MudChip>
                                </MudTooltip>
                            }
                            
                            <MudSpacer />

                            <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                           Size="Size.Small" 
                                           Style="min-height: 44px; min-width: 44px;"
                                           OnClick="@(() => OnEditEntry.InvokeAsync(entry))" />
                            @if (!entry.ScrobbledToLastFm)
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.MusicNote" 
                                               Size="Size.Small" 
                                               Color="Color.Secondary"
                                               Style="min-height: 44px; min-width: 44px;"
                                               OnClick="@(() => HandleScrobbleAsync(entry))"
                                               aria-label="Scrobble to Last.fm"
                                               title="Scrobble to Last.fm" />
                            }
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                           Size="Size.Small"
                                           Style="min-height: 44px; min-width: 44px;" 
                                           Color="Color.Error"
                                           OnClick="@(() => HandleDeleteAsync(entry.Id))" />
                        </MudStack>
                    </MudStack>
                </MudListItem>
                <MudDivider />
            }
        </MudList>

        @if (PagedResponse != null && PagedResponse.TotalPages > 1)
        {
            <MudPagination Class="mt-3" 
                           Count="@PagedResponse.TotalPages" 
                           Selected="@PagedResponse.PageNumber" 
                           SelectedChanged="OnPageChangedAsync" 
                           ShowFirstButton 
                           ShowLastButton />
        }
    }
</MudPaper>

@code {
    [Parameter]
    public EventCallback<EntryDto> OnEditEntry { get; set; }

    [Parameter]
    public EventCallback OnEntryChanged { get; set; }

    [Parameter]
    public EventCallback OnCreateFirstEntry { get; set; }

    private List<EntryDto> Entries { get; set; } = new();
    private PagedResponse<EntryDto>? PagedResponse { get; set; }
    private bool IsLoading { get; set; }
    private string? _liveMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadEntriesAsync();
    }

    public async Task LoadEntriesAsync()
    {
        IsLoading = true;
        _liveMessage = "Loading entries...";
        StateHasChanged();

        try
        {
            var request = new PaginationRequest
            {
                PageNumber = 1,
                PageSize = 10,
                SortBy = "created",
                SortDirection = "desc"
            };

            PagedResponse = await EntryApi.GetEntriesAsync(request);

            if (PagedResponse != null)
            {
                Entries = PagedResponse.Items;
                _liveMessage = $"Loaded {Entries.Count} entries.";
            }
            else
            {
                _liveMessage = "Failed to load entries.";
                Snackbar.Add("Failed to load entries", Severity.Error);
            }
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnPageChangedAsync(int page)
    {
        IsLoading = true;
        _liveMessage = "Loading entries...";
        StateHasChanged();

        try
        {
            var request = new PaginationRequest
            {
                PageNumber = page,
                PageSize = 10,
                SortBy = "created",
                SortDirection = "desc"
            };

            PagedResponse = await EntryApi.GetEntriesAsync(request);

            if (PagedResponse != null)
            {
                Entries = PagedResponse.Items;
                _liveMessage = $"Page {page} loaded with {Entries.Count} entries.";
            }
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleDeleteAsync(Guid id)
    {
        var success = await EntryApi.DeleteEntryAsync(id);

        if (success)
        {
            Snackbar.Add("Entry deleted", Severity.Success);
            _liveMessage = "Entry deleted.";
            await LoadEntriesAsync();
            await OnEntryChanged.InvokeAsync();
        }
        else
        {
            _liveMessage = "Failed to delete entry.";
            Snackbar.Add("Failed to delete entry", Severity.Error);
        }
    }

    private async Task HandleScrobbleAsync(EntryDto entry)
    {
        var success = await LastFmApi.ScrobbleAsync(
            entry.SongTitle, 
            entry.ArtistName, 
            entry.AlbumName, 
            entry.CreatedAt);

        if (success)
        {
            Snackbar.Add($"Scrobbled '{entry.SongTitle}' to Last.fm", Severity.Success);
            _liveMessage = $"Scrobbled {entry.SongTitle} to Last.fm.";
            await LoadEntriesAsync();
            await OnEntryChanged.InvokeAsync();
        }
        else
        {
            _liveMessage = "Failed to scrobble to Last.fm.";
            Snackbar.Add("Failed to scrobble to Last.fm", Severity.Error);
        }
    }

    private Color GetMoodColor(double valence)
    {
        return valence switch
        {
            > 0.3 => Color.Success,
            < -0.3 => Color.Error,
            _ => Color.Warning
        };
    }

    private Color GetSourceColor(string source)
    {
        return source?.ToLowerInvariant() switch
        {
            "itunes" => Color.Info,
            "lastfm" => Color.Secondary,
            "deezer" => Color.Tertiary,
            _ => Color.Dark
        };
    }

    private string GetMoodLabel(double valence, double arousal)
    {
        return (valence, arousal) switch
        {
            ( > 0.3, > 0.3) => "Happy",
            ( > 0.3, < -0.3) => "Calm",
            ( < -0.3, > 0.3) => "Angry",
            ( < -0.3, < -0.3) => "Sad",
            _ => "Neutral"
        };
    }

    private string GetSourceBadge(string source)
    {
        return source?.ToLowerInvariant() switch
        {
            "musicbrainz" => "Source: MusicBrainz",
            "itunes" => "Source: iTunes",
            "lastfm" => "Source: Last.fm",
            "deezer" => "Source: Deezer",
            "manual" => "Source: Manual",
            _ => source ?? "Unknown"
        };
    }
}
