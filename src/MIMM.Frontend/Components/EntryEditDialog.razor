@using MIMM.Shared.Dtos
@using MIMM.Frontend.Services
@using MIMM.Frontend.Models
@inject IEntryApiService EntryApi
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudDialog aria-modal="true" role="dialog">
    <DialogContent>
        <div tabindex="0" @onfocus="FocusFirstAsync" class="sr-only"></div>
        @if (_isLoading)
        {
            <MudProgressCircular Indeterminate />
        }
        else if (Model != null)
        {
            <MudForm @ref="_form" @bind-IsValid="@_isFormValid">
                <MudStack Spacing="3">
                    <MudTextField @bind-Value="Model.SongTitle" 
                                  Label="Song title" 
                                  Required 
                                  RequiredError="Song title is required"
                                  HelperText="@(string.IsNullOrEmpty(Model.SongId) ? "" : $"MusicBrainz ID: {Model.SongId}")" />

                    <MudTextField @bind-Value="Model.ArtistName" Label="Artist" />

                    <MudTextField @bind-Value="Model.AlbumName" Label="Album" />

                    <MudPaper Class="pa-3" Elevation="0" Style="background-color:rgba(0,0,0,0.02);">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle2">Find a track</MudText>

                            @if (_selectedTrack is not null)
                            {
                                <MudPaper Class="pa-2" Elevation="0" Style="background-color:rgba(33,150,243,0.1); border-left:4px solid #2196F3;">
                                    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                        @if (!string.IsNullOrEmpty(_selectedTrack.CoverUrl))
                                        {
                                            <MudAvatar src="@_selectedTrack.CoverUrl" Size="Size.Large" Class="rounded" />
                                        }
                                        else
                                        {
                                            <MudAvatar Color="Color.Primary" Size="Size.Large">
                                                <MudIcon Icon="@Icons.Material.Filled.MusicNote" />
                                            </MudAvatar>
                                        }
                                        
                                        <MudStack Spacing="0" Style="flex:1;">
                                            <MudText Typo="Typo.body1" Style="font-weight:500;">@_selectedTrack.Title</MudText>
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">@_selectedTrack.Artist</MudText>
                                            @if (!string.IsNullOrEmpty(_selectedTrack.Album))
                                            {
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@_selectedTrack.Album</MudText>
                                            }
                                            @if (!string.IsNullOrWhiteSpace(_selectedTrack.ExternalId))
                                            {
                                                <MudText Typo="Typo.caption" Color="Color.Tertiary">
                                                    <strong>@(_selectedTrack.Source == "musicbrainz" ? "ðŸŽµ MusicBrainz" : "ðŸŽµ " + _selectedTrack.Source)</strong>
                                                </MudText>
                                            }
                                        </MudStack>
                                        
                                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Size="Size.Small" OnClick="ClearSelection">
                                            Change
                                        </MudButton>
                                    </MudStack>
                                </MudPaper>
                            }

                            <MusicSearchBox OnTrackSelected="HandleTrackSelected" />
                        </MudStack>
                    </MudPaper>

                    <MudDivider Class="my-2" />

                    <MoodSelector2D @bind-Valence="Model.Valence"
                                     @bind-Arousal="Model.Arousal" />

                    <MudStack Spacing="2">
                        <MudText Typo="Typo.body2">Tension level: @Model.TensionLevel</MudText>
                        <MudSlider @bind-Value="Model.TensionLevel" 
                                   Min="0" 
                                   Max="100" 
                                   Step="5" 
                                   Color="Color.Tertiary" />
                    </MudStack>

                    <MudDivider Class="my-2" />

                    <MudText Typo="Typo.subtitle2">Somatic tags</MudText>
                    <MudStack Row Wrap="Wrap.Wrap" Spacing="1">
                        @foreach (var tag in CommonSomaticTags)
                        {
                            <MudChip T="string" Size="Size.Small" 
                                     Color="@(SelectedTags.Contains(tag) ? Color.Primary : Color.Default)"
                                     Variant="@(SelectedTags.Contains(tag) ? Variant.Filled : Variant.Outlined)"
                                     OnClick="@(() => ToggleTag(tag))">
                                @tag
                            </MudChip>
                        }
                    </MudStack>

                    <MudTextField @bind-Value="CustomTag" 
                                  Label="Add custom tag" 
                                  Adornment="Adornment.End" 
                                  AdornmentIcon="@Icons.Material.Filled.Add"
                                  OnAdornmentClick="AddCustomTag" 
                                  OnKeyDown="OnCustomTagKeyDown" />

                    <MudTextField @bind-Value="Model.Notes" 
                                  Label="Notes (optional)" 
                                  Lines="4" 
                                  MaxLength="2000"
                                  Counter="2000" />
                </MudStack>
            </MudForm>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" ButtonType="ButtonType.Button" @ref="_firstFocusable">Cancel</MudButton>
        <MudButton Color="Color.Error" 
                   Variant="Variant.Outlined" 
                   OnClick="HandleDeleteAsync" 
                   Disabled="@_isSubmitting">
            Delete
        </MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   OnClick="SubmitAsync" 
                   Disabled="@(!_isFormValid || _isSubmitting)">
            @if (_isSubmitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate Class="mr-2" />
            }
            Save changes
        </MudButton>
        <div tabindex="0" @onfocus="FocusFirstAsync" class="sr-only"></div>
    </DialogActions>
</MudDialog>

    <div tabindex="0" @onfocus="FocusFirstAsync" class="sr-only"></div>


@code {
    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public Guid EntryId { get; set; }

    [Parameter]
    public EventCallback OnEntryUpdated { get; set; }

    private MudForm _form = null!;
    private bool _isFormValid;
    private bool _isSubmitting;
    private bool _isLoading = true;
    private bool _hasFocused;
    private MusicTrackDto? _selectedTrack;
    private MudButton? _firstFocusable;

    private UpdateEntryModel Model { get; set; } = new();
    private HashSet<string> SelectedTags { get; set; } = [];
    private string CustomTag { get; set; } = string.Empty;

    private static readonly string[] CommonSomaticTags =
    [
        "Relaxed", "Tense", "Energetic", "Tired", 
        "Warm", "Cold", "Tingling", "Heavy", 
        "Light", "Grounded", "Floating", "Centered"
    ];

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_hasFocused)
        {
            _hasFocused = true;
            await FocusFirstAsync();
        }
    }

    private async Task FocusFirstAsync()
    {
        if (_firstFocusable is not null)
        {
            await _firstFocusable.FocusAsync();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadEntryAsync();
    }

    private async Task LoadEntryAsync()
    {
        _isLoading = true;

        try
        {
            var entry = await EntryApi.GetEntryByIdAsync(EntryId);

            if (entry != null)
            {
                Model = new UpdateEntryModel
                {
                    SongTitle = entry.SongTitle,
                    ArtistName = entry.ArtistName,
                    AlbumName = entry.AlbumName,
                    CoverUrl = entry.CoverUrl,
                    SongId = entry.SongId,
                    Valence = entry.Valence,
                    Arousal = entry.Arousal,
                    TensionLevel = entry.TensionLevel ?? 50,
                    SomaticTags = entry.SomaticTags,
                    Notes = entry.Notes
                };

                if (entry.SomaticTags != null)
                {
                    SelectedTags = [.. entry.SomaticTags];
                }
            }
            else
            {
                Snackbar.Add("Failed to load entry", Severity.Error);
                MudDialog.Cancel();
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ToggleTag(string tag)
    {
        if (SelectedTags.Contains(tag))
        {
            SelectedTags.Remove(tag);
        }
        else
        {
            SelectedTags.Add(tag);
        }
    }

    private void AddCustomTag()
    {
        if (!string.IsNullOrWhiteSpace(CustomTag))
        {
            SelectedTags.Add(CustomTag.Trim());
            CustomTag = string.Empty;
        }
    }

    private void OnCustomTagKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            AddCustomTag();
        }
    }

    private void HandleTrackSelected(MusicTrackDto track)
    {
        _selectedTrack = track;
        Model.SongTitle = track.Title;
        Model.ArtistName = track.Artist;
        Model.AlbumName = track.Album;
        Model.CoverUrl = track.CoverUrl;
        Model.SongId = track.ExternalId;
        StateHasChanged();
    }

    private void ClearSelection()
    {
        _selectedTrack = null;
        StateHasChanged();
    }

    private async Task SubmitAsync()
    {
        await _form.Validate();

        if (!_isFormValid)
        {
            return;
        }

        _isSubmitting = true;

        try
        {
            var request = new UpdateEntryRequest
            {
                SongTitle = Model.SongTitle,
                ArtistName = Model.ArtistName,
                AlbumName = Model.AlbumName,
                CoverUrl = _selectedTrack?.CoverUrl ?? Model.CoverUrl,
                Valence = Model.Valence,
                Arousal = Model.Arousal,
                TensionLevel = Model.TensionLevel,
                SomaticTags = [.. SelectedTags],
                Notes = Model.Notes
            };

            var result = await EntryApi.UpdateEntryAsync(EntryId, request);

            if (result != null)
            {
                Snackbar.Add("Entry updated successfully", Severity.Success);
                await OnEntryUpdated.InvokeAsync();
                MudDialog.Close(DialogResult.Ok(result));
            }
            else
            {
                Snackbar.Add("Failed to update entry", Severity.Error);
            }
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private async Task HandleDeleteAsync()
    {
        var parameters = new DialogParameters
        {
            { "ContentText", "Are you sure you want to delete this entry? This action cannot be undone." },
            { "ButtonText", "Delete" },
            { "Color", Color.Error }
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete entry", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            _isSubmitting = true;

            try
            {
                var success = await EntryApi.DeleteEntryAsync(EntryId);

                if (success)
                {
                    Snackbar.Add("Entry deleted successfully", Severity.Success);
                    await OnEntryUpdated.InvokeAsync();
                    MudDialog.Close(DialogResult.Ok(true));
                }
                else
                {
                    Snackbar.Add("Failed to delete entry", Severity.Error);
                }
            }
            finally
            {
                _isSubmitting = false;
            }
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
