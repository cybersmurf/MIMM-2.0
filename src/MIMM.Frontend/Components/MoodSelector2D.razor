@using Microsoft.AspNetCore.Components.Web
@using System.Globalization
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<MudStack Spacing="1">
    <MudText Typo="Typo.subtitle2">Mood (Russell 2D)</MudText>
    
    <canvas id="@_canvasId"
            width="@Size" height="@Size"
            role="slider"
            aria-label="Mood selector: valence (left/right) and arousal (up/down)"
            aria-valuemin="-1"
            aria-valuemax="1"
            aria-valuenow="@Valence.ToString("F2", CultureInfo.InvariantCulture)"
            tabindex="0"
            style="display: block; width: @(Size)px; height: @(Size)px; cursor: crosshair; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1);">
    </canvas>
    
    <MudText Typo="Typo.caption" Color="Color.Secondary">
        @MoodLabel (V @Valence.ToString("F2", CultureInfo.InvariantCulture), A @Arousal.ToString("F2", CultureInfo.InvariantCulture))
    </MudText>
    <MudText Typo="Typo.caption" Color="Color.Secondary">
        Click or drag to set mood. Center is neutral; top-right is happy/energized; bottom-left is sad/calm.
    </MudText>
</MudStack>

@code {
    private string _canvasId = $"mood-canvas-{Guid.NewGuid():N}";
    private DotNetObjectReference<MoodSelector2D>? _dotNetRef;

    [Parameter]
    public double Valence { get; set; }

    [Parameter]
    public EventCallback<double> ValenceChanged { get; set; }

    [Parameter]
    public double Arousal { get; set; }

    [Parameter]
    public EventCallback<double> ArousalChanged { get; set; }

    [Parameter]
    public EventCallback<(double Valence, double Arousal)> OnChanged { get; set; }

    [Parameter]
    public int Size { get; set; } = 320;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _dotNetRef = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("initMoodSelector", _canvasId, Size, _dotNetRef);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing mood selector: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public async Task OnPositionChanged(double valence, double arousal)
    {
        var valenceChanged = !valence.Equals(Valence);
        var arousalChanged = !arousal.Equals(Arousal);

        if (valenceChanged)
        {
            Valence = valence;
            if (ValenceChanged.HasDelegate)
            {
                await ValenceChanged.InvokeAsync(valence);
            }
        }

        if (arousalChanged)
        {
            Arousal = arousal;
            if (ArousalChanged.HasDelegate)
            {
                await ArousalChanged.InvokeAsync(arousal);
            }
        }

        if (OnChanged.HasDelegate && (valenceChanged || arousalChanged))
        {
            await OnChanged.InvokeAsync((valence, arousal));
        }
        
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("destroyMoodSelector", _canvasId);
            _dotNetRef?.Dispose();
        }
        catch { /* ignore disposal errors */ }
    }

    private string MoodLabel => (Valence, Arousal) switch
    {
        (> 0.3, > 0.3) => "Excited / Happy",
        (> 0.3, < -0.3) => "Calm / Content",
        (< -0.3, > 0.3) => "Tense / Frustrated",
        (< -0.3, < -0.3) => "Low / Down",
        _ => "Neutral"
    };
}


