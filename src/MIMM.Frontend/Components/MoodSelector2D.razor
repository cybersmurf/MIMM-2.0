@using Microsoft.AspNetCore.Components.Web

<MudStack Spacing="1">
    <MudText Typo="Typo.subtitle2">Mood (Russell 2D)</MudText>
    <MudPaper Class="mood-plane" Elevation="2" Style=$"width:{Size}px;height:{Size}px;"
              @onpointerdown="OnPointerDown"
              @onpointermove="OnPointerMove"
              @onpointerup="StopDragging"
              @onpointerleave="StopDragging">
        <div class="axis-label axis-label-x-left">Negative valence</div>
        <div class="axis-label axis-label-x-right">Positive valence</div>
        <div class="axis-label axis-label-y-top">High arousal</div>
        <div class="axis-label axis-label-y-bottom">Low arousal</div>

        <div class="grid">
            <div class="grid-line vertical" style="left:25%"></div>
            <div class="grid-line vertical" style="left:50%"></div>
            <div class="grid-line vertical" style="left:75%"></div>
            <div class="grid-line horizontal" style="top:25%"></div>
            <div class="grid-line horizontal" style="top:50%"></div>
            <div class="grid-line horizontal" style="top:75%"></div>
        </div>

        <div class="cursor" style="left:@CursorLeft%; top:@CursorTop%"></div>

        <MudChip Class="label-chip" Color="Color.Primary" Variant="Variant.Filled" Size="Size.Small">
            @MoodLabel (V @Valence.ToString("F2"), A @Arousal.ToString("F2"))
        </MudChip>
    </MudPaper>
    <MudText Typo="Typo.caption" Color="Color.Secondary">
        Click or drag to set valence (X) and arousal (Y). Center is neutral; top-right is happy/energized; bottom-left is sad/calm.
    </MudText>
</MudStack>

@code {
    [Parameter]
    public double Valence { get; set; }

    [Parameter]
    public EventCallback<double> ValenceChanged { get; set; }

    [Parameter]
    public double Arousal { get; set; }

    [Parameter]
    public EventCallback<double> ArousalChanged { get; set; }

    [Parameter]
    public EventCallback<(double Valence, double Arousal)> OnChanged { get; set; }

    [Parameter]
    public int Size { get; set; } = 320;

    private bool _isDragging;

    private double CursorLeft => Math.Clamp((Valence + 1) / 2 * 100, 0, 100);
    private double CursorTop => Math.Clamp(0.5 * (1 - Arousal) * 100, 0, 100);

    private async Task OnPointerDown(PointerEventArgs e)
    {
        _isDragging = true;
        await UpdateFromPointerAsync(e);
    }

    private async Task OnPointerMove(PointerEventArgs e)
    {
        if (!_isDragging)
        {
            return;
        }

        await UpdateFromPointerAsync(e);
    }

    private void StopDragging(PointerEventArgs _)
    {
        _isDragging = false;
    }

    private async Task UpdateFromPointerAsync(PointerEventArgs e)
    {
        var x = e.OffsetX;
        var y = e.OffsetY;

        if (x < 0 || y < 0)
        {
            return;
        }

        var valence = Math.Clamp((x / Size) * 2 - 1, -1, 1);
        var arousal = Math.Clamp(1 - (y / Size) * 2, -1, 1);

        await SetValuesAsync(valence, arousal);
    }

    private async Task SetValuesAsync(double valence, double arousal)
    {
        var valenceChanged = !valence.Equals(Valence);
        var arousalChanged = !arousal.Equals(Arousal);

        if (valenceChanged)
        {
            Valence = valence;
            if (ValenceChanged.HasDelegate)
            {
                await ValenceChanged.InvokeAsync(valence);
            }
        }

        if (arousalChanged)
        {
            Arousal = arousal;
            if (ArousalChanged.HasDelegate)
            {
                await ArousalChanged.InvokeAsync(arousal);
            }
        }

        if (OnChanged.HasDelegate && (valenceChanged || arousalChanged))
        {
            await OnChanged.InvokeAsync((valence, arousal));
        }
    }

    private string MoodLabel => (Valence, Arousal) switch
    {
        (> 0.3, > 0.3) => "Excited / Happy",
        (> 0.3, < -0.3) => "Calm / Content",
        (< -0.3, > 0.3) => "Tense / Frustrated",
        (< -0.3, < -0.3) => "Low / Down",
        _ => "Neutral"
    };
}

<style>
.mood-plane {
    position: relative;
    width: 100%;
    max-width: 340px;
    aspect-ratio: 1 / 1;
    border-radius: 12px;
    background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.1), rgba(0,0,0,0.05)),
                linear-gradient(135deg, rgba(34,197,94,0.12), rgba(59,130,246,0.12));
    overflow: hidden;
    user-select: none;
    cursor: crosshair;
}

.mood-plane .grid-line {
    position: absolute;
    background: rgba(0,0,0,0.06);
    pointer-events: none;
}

.mood-plane .grid-line.vertical {
    top: 0;
    bottom: 0;
    width: 1px;
}

.mood-plane .grid-line.horizontal {
    left: 0;
    right: 0;
    height: 1px;
}

.mood-plane .cursor {
    position: absolute;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 2px solid var(--mud-palette-primary);
    background: white;
    box-shadow: 0 0 6px rgba(0,0,0,0.12);
    transform: translate(-50%, -50%);
    pointer-events: none;
}

.mood-plane .label-chip {
    position: absolute;
    left: 8px;
    top: 8px;
    pointer-events: none;
}

.axis-label {
    position: absolute;
    font-size: 0.75rem;
    color: rgba(0,0,0,0.6);
    pointer-events: none;
}

.axis-label-x-left { left: 6px; top: 50%; transform: translateY(-50%); }
.axis-label-x-right { right: 6px; top: 50%; transform: translateY(-50%); text-align: right; }
.axis-label-y-top { left: 50%; top: 6px; transform: translateX(-50%); }
.axis-label-y-bottom { left: 50%; bottom: 6px; transform: translateX(-50%); }
</style>
