@page "/export-import"
@using MIMM.Frontend.Services
@using MIMM.Shared.Dtos
@inject IExportImportApiService ExportImportApi
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<PageTitle>Export & Import - MIMM</PageTitle>

<LiveRegion Message="@_liveMessage" AriaLive="polite" />

<MudContainer MaxWidth="MaxWidth.Large" Class="py-8">
    <MudStack Spacing="4">
        <!-- Page Header -->
        <MudStack Spacing="1">
            <MudText Typo="Typo.h4">Export & Import</MudText>
            <MudText Typo="Typo.body2">
                Backup your entries or restore from a previous backup. Data portability for your music & mood journal.
            </MudText>
        </MudStack>

        <MudGrid Spacing="3">
            <!-- EXPORT SECTION -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="0" Class="glass-card">
                    <MudCardContent>
                        <MudStack Spacing="3">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.FileDownload" Color="Color.Primary" Size="Size.Large" />
                                <MudText Typo="Typo.subtitle1">Export Your Data</MudText>
                            </MudStack>

                            <MudText Typo="Typo.body2">
                                Download all your entries in CSV or JSON format. Perfect for backups and analysis.
                            </MudText>

                            <MudStack Spacing="2">
                                <MudButton 
                                    Variant="Variant.Filled"
                                    Color="Color.Primary"
                                    FullWidth="true"
                                    StartIcon="@Icons.Material.Filled.FileDownload"
                                    OnClick="ExportAsCsv"
                                    Disabled="@_isExporting">
                                    @if (_isExporting)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
                                        <span>Exporting...</span>
                                    }
                                    else
                                    {
                                        <span>Export as CSV</span>
                                    }
                                </MudButton>

                                <MudButton 
                                    Variant="Variant.Filled"
                                    Color="Color.Secondary"
                                    FullWidth="true"
                                    StartIcon="@Icons.Material.Filled.FileDownload"
                                    OnClick="ExportAsJson"
                                    Disabled="@_isExporting">
                                    @if (_isExporting)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
                                        <span>Exporting...</span>
                                    }
                                    else
                                    {
                                        <span>Export as JSON</span>
                                    }
                                </MudButton>

                                <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense="true" Class="mt-2">
                                    CSV is great for spreadsheets. JSON preserves all metadata.
                                </MudAlert>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- IMPORT SECTION -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="0" Class="glass-card">
                    <MudCardContent>
                        <MudStack Spacing="3">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.FileUpload" Color="Color.Success" Size="Size.Large" />
                                <MudText Typo="Typo.subtitle1">Import Your Data</MudText>
                            </MudStack>

                            <MudText Typo="Typo.body2">
                                Restore entries from a CSV or JSON file. Invalid entries will be skipped.
                            </MudText>

                            <MudStack Spacing="2">
                                <input type="file" accept=".csv" id="csvFileInput" @onchange="OnCsvSelected" style="display:none" />
                                <MudButton HtmlTag="label" 
                                           Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.FileUpload"
                                           for="csvFileInput"
                                           Disabled="@_isImporting"
                                           Style="cursor: pointer">
                                    @if (_isImporting && _currentImportType == "csv")
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
                                        <span>Importing...</span>
                                    }
                                    else
                                    {
                                        <span>Import CSV</span>
                                    }
                                </MudButton>

                                <input type="file" accept=".json" id="jsonFileInput" @onchange="OnJsonSelected" style="display:none" />
                                <MudButton HtmlTag="label"
                                           Variant="Variant.Filled"
                                           Color="Color.Secondary"
                                           FullWidth="true"
                                           StartIcon="@Icons.Material.Filled.FileUpload"
                                           for="jsonFileInput"
                                           Disabled="@_isImporting"
                                           Style="cursor: pointer">
                                    @if (_isImporting && _currentImportType == "json")
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
                                        <span>Importing...</span>
                                    }
                                    else
                                    {
                                        <span>Import JSON</span>
                                    }
                                </MudButton>

                                <MudCheckBox @bind-Value="@_continueOnError" 
                                             Label="Skip invalid entries (continue on error)"
                                             Color="Color.Primary" />

                                <MudAlert Severity="Severity.Info" Variant="Variant.Text" Dense="true" Class="mt-2">
                                    Files must match the export format for best results.
                                </MudAlert>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- IMPORT RESULTS -->
        @if (_lastImportResult != null)
        {
            <MudCard Elevation="0" Class="glass-card">
                <MudCardContent>
                    <MudStack Spacing="3">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Assessment" Color="Color.Info" Size="Size.Large" />
                            <MudText Typo="Typo.subtitle1">Import Results</MudText>
                        </MudStack>

                        <MudGrid Spacing="2">
                            <MudItem xs="6" sm="3">
                                <MudCard Outlined>
                                    <MudCardContent>
                                        <MudStack Spacing="1" AlignItems="AlignItems.Center">
                                            <MudIcon Icon="@Icons.Material.Filled.List" Size="Size.Medium" Color="Color.Default" />
                                            <MudText Typo="Typo.caption">Total Processed</MudText>
                                            <MudText Typo="Typo.h5">@_lastImportResult.TotalProcessed</MudText>
                                        </MudStack>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudCard Outlined>
                                    <MudCardContent>
                                        <MudStack Spacing="1" AlignItems="AlignItems.Center">
                                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Medium" Color="Color.Success" />
                                            <MudText Typo="Typo.caption" Color="Color.Success">Imported</MudText>
                                            <MudText Typo="Typo.h5" Color="Color.Success">@_lastImportResult.SuccessfullyImported</MudText>
                                        </MudStack>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudCard Outlined>
                                    <MudCardContent>
                                        <MudStack Spacing="1" AlignItems="AlignItems.Center">
                                            <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Medium" Color="@(_lastImportResult.FailedCount > 0 ? Color.Error : Color.Success)" />
                                            <MudText Typo="Typo.caption" Color="@(_lastImportResult.FailedCount > 0 ? Color.Error : Color.Success)">Failed</MudText>
                                            <MudText Typo="Typo.h5" Color="@(_lastImportResult.FailedCount > 0 ? Color.Error : Color.Success)">@_lastImportResult.FailedCount</MudText>
                                        </MudStack>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudCard Outlined>
                                    <MudCardContent>
                                        <MudStack Spacing="1" AlignItems="AlignItems.Center">
                                            <MudIcon Icon="@Icons.Material.Filled.Percent" Size="Size.Medium" Color="Color.Info" />
                                            <MudText Typo="Typo.caption">Success Rate</MudText>
                                            <MudText Typo="Typo.h5">
                                                @if (_lastImportResult.TotalProcessed > 0)
                                                {
                                                    @($"{(decimal)_lastImportResult.SuccessfullyImported / _lastImportResult.TotalProcessed * 100:F0}%")
                                                }
                                                else
                                                {
                                                    @("0%")
                                                }
                                            </MudText>
                                        </MudStack>
                                    </MudCardContent>
                                </MudCard>
                            </MudItem>
                        </MudGrid>

                        @if (_lastImportResult.Errors.Count > 0)
                        {
                            <MudExpansionPanels>
                                <MudExpansionPanel>
                                    <TitleContent>
                                        <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                            <MudIcon Icon="@Icons.Material.Filled.ErrorOutline" Color="Color.Error" />
                                            <MudText>Errors (@_lastImportResult.Errors.Count)</MudText>
                                        </MudStack>
                                    </TitleContent>
                                    <ChildContent>
                                        <MudStack Spacing="2" Class="pa-2">
                                            @foreach (var error in _lastImportResult.Errors)
                                            {
                                                <MudAlert Severity="Severity.Error" Dense="true">
                                                    @if (error.LineNumber.HasValue)
                                                    {
                                                        <strong>Line @error.LineNumber:</strong>
                                                    }
                                                    @error.ErrorMessage
                                                </MudAlert>
                                            }
                                        </MudStack>
                                    </ChildContent>
                                </MudExpansionPanel>
                            </MudExpansionPanels>
                        }
                    </MudStack>
                </MudCardContent>
            </MudCard>
        }

        <!-- INFO SECTION -->
        <MudCard Elevation="0" Class="glass-card">
            <MudCardContent>
                <MudStack Spacing="3">
                    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Info" Size="Size.Large" />
                        <MudText Typo="Typo.subtitle1">Information</MudText>
                    </MudStack>
                    <MudStack Spacing="2">
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Start">
                            <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" />
                            <MudText Typo="Typo.body2">All exports are private and stay on your device.</MudText>
                        </MudStack>
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Start">
                            <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" />
                            <MudText Typo="Typo.body2">CSV format is compatible with Excel, Google Sheets, and most databases.</MudText>
                        </MudStack>
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Start">
                            <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" />
                            <MudText Typo="Typo.body2">JSON format preserves all metadata including tags and timestamps.</MudText>
                        </MudStack>
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Start">
                            <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" />
                            <MudText Typo="Typo.body2">Import safely skips invalid entries without losing valid data.</MudText>
                        </MudStack>
                    </MudStack>
                </MudStack>
            </MudCardContent>
        </MudCard>
    </MudStack>
</MudContainer>

@code {
    private string? _liveMessage;
    private bool _isExporting = false;
    private bool _isImporting = false;
    private string? _currentImportType;
    private bool _continueOnError = true;
    private ImportResponse? _lastImportResult;

    private async Task ExportAsCsv()
    {
        _isExporting = true;
        try
        {
            var csvData = await ExportImportApi.ExportAsCSVAsync();
            if (csvData != null)
            {
                // Trigger download
                await JS.InvokeVoidAsync("downloadFile", 
                    "entries_" + DateTime.Now.ToString("yyyyMMdd_HHmmss") + ".csv",
                    "text/csv",
                    csvData);
                
                Snackbar.Add("Entries exported as CSV successfully!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to export entries", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting entries: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isExporting = false;
        }
    }

    private async Task ExportAsJson()
    {
        _isExporting = true;
        try
        {
            var jsonData = await ExportImportApi.ExportAsJsonAsync();
            if (jsonData != null)
            {
                // Trigger download
                await JS.InvokeVoidAsync("downloadFile",
                    "entries_" + DateTime.Now.ToString("yyyyMMdd_HHmmss") + ".json",
                    "application/json",
                    System.Text.Encoding.UTF8.GetBytes(jsonData));
                
                Snackbar.Add("Entries exported as JSON successfully!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to export entries", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting entries: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isExporting = false;
        }
    }

    private async Task OnCsvSelected(ChangeEventArgs e)
    {
        _isImporting = true;
        _currentImportType = "csv";
        _lastImportResult = null;

        try
        {
            var inputElement = await JS.InvokeAsync<string>("eval", "document.getElementById('csvFileInput').files[0]");
            // For now we'll skip the file read - this will need native JS interop
            // which is complex. Instead we'll provide a simpler approach below.
            Snackbar.Add("Please use file upload dialog", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error preparing CSV import: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isImporting = false;
            _currentImportType = null;
        }
    }

    private async Task OnJsonSelected(ChangeEventArgs e)
    {
        _isImporting = true;
        _currentImportType = "json";
        _lastImportResult = null;

        try
        {
            var inputElement = await JS.InvokeAsync<string>("eval", "document.getElementById('jsonFileInput').files[0]");
            // For now we'll skip the file read - this will need native JS interop
            // which is complex. Instead we'll provide a simpler approach below.
            Snackbar.Add("Please use file upload dialog", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error preparing JSON import: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isImporting = false;
            _currentImportType = null;
        }
    }
}

<style>
.glass-card {
    background: rgba(255, 255, 255, 0.05) !important;
    backdrop-filter: blur(10px) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 12px !important;
}
</style>
