@page "/dashboard"
@using MIMM.Frontend.Services
@using MIMM.Frontend.Components
@using MIMM.Shared.Dtos
@inject IAuthStateService AuthState
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IAnalyticsApiService AnalyticsApi
@inject ILastFmApiService LastFmApi

<PageTitle>Dashboard - MIMM</PageTitle>

<LiveRegion Message="@_liveRegionMessage" AriaLive="polite" />

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6" role="region" aria-label="Dashboard overview">
    <!-- Header Section with Gradient -->
    <MudPaper Class="mb-6 pa-8" Elevation="2" 
              Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #d946ef 100%); border-radius: 16px;">
        <MudStack Spacing="3">
            <MudText Typo="Typo.h3" Class="text-white" Style="font-weight: 800;">Welcome back ðŸ‘‹</MudText>
            <MudText Typo="Typo.subtitle1" Class="text-white" 
                     Style="opacity: 0.95; letter-spacing: 0.3px;">
                Capture today's mood and soundtrack. Stay connected to your inner music.
            </MudText>
            <MudStack Row="true" Spacing="2" Style="flex-wrap: wrap; margin-top: 16px;">
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Surface"
                           Style="color: #667eea; font-weight: 700; background: rgba(255, 255, 255, 0.95) !important;"
                           StartIcon="@Icons.Material.Filled.AddCircle"
                           Size="Size.Large"
                           OnClick="OpenCreateDialog">
                    New Entry
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                           Color="Color.Inherit"
                           Style="color: white; border-color: rgba(255, 255, 255, 0.5); font-weight: 700;"
                           StartIcon="@Icons.Material.Filled.CloudUpload"
                           Size="Size.Large"
                           OnClick="ConnectLastFm">
                    Connect Last.fm
                </MudButton>
            </MudStack>
        </MudStack>
    </MudPaper>

    <!-- Stats Grid -->
    <MudGrid Spacing="3" Class="mb-6">
        @if (_isLoadingStats)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="160px" Class="skeleton-shimmer" />
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="160px" Class="skeleton-shimmer" />
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="160px" Class="skeleton-shimmer" />
            </MudItem>
        }
        else if (_moodTrend != null)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudPaper Elevation="2" Class="pa-6" 
                          Style="background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); border-radius: 16px; min-height: 180px; display: flex; flex-direction: column; justify-content: space-between;">
                    <div>
                        <MudText Typo="Typo.caption" Class="text-white" Style="font-weight: 700; letter-spacing: 1px; opacity: 0.9;">Mood Balance</MudText>
                        <MudText Typo="Typo.h4" Class="text-white" Style="font-weight: 800; letter-spacing: -1px; margin-top: 8px;">@_moodTrend.AverageValence.ToString("F1")</MudText>
                    </div>
                    <MudText Typo="Typo.body2" Class="text-white" Style="opacity: 0.85;">Valence (averaged last 7 days)</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudPaper Elevation="2" Class="pa-6" 
                          Style="background: linear-gradient(135deg, #a855f7 0%, #d946ef 100%); border-radius: 16px; min-height: 180px; display: flex; flex-direction: column; justify-content: space-between;">
                    <div>
                        <MudText Typo="Typo.caption" Class="text-white" Style="font-weight: 700; letter-spacing: 1px; opacity: 0.9;">Energy Trend</MudText>
                        <MudText Typo="Typo.h4" Class="text-white" Style="font-weight: 800; letter-spacing: -1px; margin-top: 8px;">@_moodTrend.AverageArousal.ToString("F1")</MudText>
                    </div>
                    <MudText Typo="Typo.body2" Class="text-white" Style="opacity: 0.85;">Arousal (last @_moodTrend.TotalEntries sessions)</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudPaper Elevation="2" Class="pa-6" 
                          Style="background: linear-gradient(135deg, #22c55e 0%, #84cc16 100%); border-radius: 16px; min-height: 180px; display: flex; flex-direction: column; justify-content: space-between;">
                    <div>
                        <MudText Typo="Typo.caption" Class="text-white" Style="font-weight: 700; letter-spacing: 1px; opacity: 0.9;">Moods Logged</MudText>
                        <MudText Typo="Typo.h4" Class="text-white" Style="font-weight: 800; letter-spacing: -1px; margin-top: 8px;">@(_moodTrend?.TotalEntries ?? 0)</MudText>
                    </div>
                    <MudText Typo="Typo.body2" Class="text-white" Style="opacity: 0.85;">Mood entries tracked</MudText>
                </MudPaper>
            </MudItem>
        }
    </MudGrid>

    <!-- Main Content Grid -->
    <MudGrid Spacing="3">
        <MudItem xs="12" sm="12" md="8" lg="7">
            <EntryList @ref="_entryList" OnEditEntry="OpenEditDialog" OnEntryChanged="RefreshData" OnCreateFirstEntry="OpenCreateDialog" />
        </MudItem>
        <MudItem xs="12" sm="12" md="4" lg="5">
            <!-- Quick Actions -->
            <MudPaper Elevation="1" Class="pa-6 mb-6" Style="border-radius: 16px;">
                <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight: 700;">âš¡ Quick Actions</MudText>
                <MudStack Spacing="2">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               FullWidth
                               StartIcon="@Icons.Material.Filled.Edit" 
                               OnClick="OpenCreateDialog"
                               Style="font-weight: 600;">
                        Add Mood Entry
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Primary" 
                               FullWidth 
                               StartIcon="@Icons.Material.Filled.TrendingUp" 
                               Href="/analytics"
                               Style="font-weight: 600;">
                        View Analytics
                    </MudButton>
                    <MudButton Variant="Variant.Text" 
                               Color="Color.Secondary" 
                               FullWidth 
                               StartIcon="@Icons.Material.Filled.MoreHoriz"
                               Style="font-weight: 600;">
                        More Options
                    </MudButton>
                </MudStack>
            </MudPaper>

            <!-- Music Search -->
            <MudPaper Elevation="1" Class="pa-6" Style="border-radius: 16px;">
                <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight: 700;">ðŸŽµ Find Music</MudText>
                <MusicSearchBox />
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private EntryList _entryList = null!;
    private string? _liveRegionMessage;
    
    private bool _isLoadingStats = true;
    private MoodTrendDto? _moodTrend;
    private MusicStatisticsDto? _musicStats;

    protected override async Task OnInitializedAsync()
    {
        var isAuthenticated = await AuthState.IsAuthenticatedAsync();
        
        if (!isAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadStatsAsync();

        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var queryParams = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        var raw = uri.Query.StartsWith("?") ? uri.Query[1..] : uri.Query;
        foreach (var pair in raw.Split('&', StringSplitOptions.RemoveEmptyEntries))
        {
            var kv = pair.Split('=', 2);
            var key = Uri.UnescapeDataString(kv[0]);
            var value = kv.Length > 1 ? Uri.UnescapeDataString(kv[1]) : string.Empty;
            queryParams[key] = value;
        }
        if (queryParams.TryGetValue("lastfm", out var lastfm))
        {
            if (string.Equals(lastfm, "connected", StringComparison.OrdinalIgnoreCase))
            {
                Snackbar.Add("Last.fm connected successfully", Severity.Success);
                await LoadStatsAsync();
            }
            else if (string.Equals(lastfm, "error", StringComparison.OrdinalIgnoreCase))
            {
                var msg = queryParams.TryGetValue("msg", out var m) ? m : "Unknown error";
                Snackbar.Add($"Last.fm connection failed: {msg}", Severity.Error);
            }
        }
    }

    private async Task LoadStatsAsync()
    {
        _isLoadingStats = true;
        _liveRegionMessage = "Loading dashboard statistics...";
        StateHasChanged();

        try
        {
            var moodTask = AnalyticsApi.GetMoodTrendsAsync(daysLookback: 7);
            var musicTask = AnalyticsApi.GetMusicStatisticsAsync();
            await Task.WhenAll(moodTask, musicTask);
            _moodTrend = await moodTask;
            _musicStats = await musicTask;
            _liveRegionMessage = $"Dashboard loaded. {_moodTrend?.TotalEntries ?? 0} mood entries found.";
        }
        catch (Exception ex)
        {
            _liveRegionMessage = "Failed to load statistics. Please try again.";
            Snackbar.Add($"Failed to load statistics: {ex.Message}", Severity.Warning);
            _moodTrend = new MoodTrendDto { AverageValence = 0.0, AverageArousal = 0.0, TotalEntries = 0 };
            _musicStats = null;
        }
        finally
        {
            _isLoadingStats = false;
            StateHasChanged();
        }
    }

    private async Task OpenCreateDialog()
    {
        var dialog = await DialogService.ShowAsync<EntryCreateDialog>("Create new entry");
        var result = await dialog.Result;
        if (result is { Canceled: false }) await RefreshData();
    }

    private async Task OpenEditDialog(MIMM.Shared.Dtos.EntryDto entry)
    {
        var parameters = new DialogParameters { { "EntryId", entry.Id } };
        var dialog = await DialogService.ShowAsync<EntryEditDialog>($"Edit: {entry.SongTitle}", parameters);
        var result = await dialog.Result;
        if (result is { Canceled: false }) await RefreshData();
    }

    private async Task RefreshData()
    {
        await LoadStatsAsync();
        await _entryList.LoadEntriesAsync();
    }

    private async Task HandleLogout()
    {
        await AuthState.ClearTokensAsync();
        Navigation.NavigateTo("/login");
    }

    private async Task ConnectLastFm()
    {
        var url = await LastFmApi.GetAuthUrlAsync();
        if (string.IsNullOrWhiteSpace(url))
        {
            Snackbar.Add("Failed to start Last.fm authentication", Severity.Error);
            return;
        }
        Navigation.NavigateTo(url, true);
    }
}
