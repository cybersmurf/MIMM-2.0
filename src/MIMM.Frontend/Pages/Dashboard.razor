@page "/dashboard"
@using MIMM.Frontend.Services
@using MIMM.Frontend.Components
@inject IAuthStateService AuthState
@inject NavigationManager Navigation
@inject IDialogService DialogService

<PageTitle>Dashboard - MIMM</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-6">
    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="8">
            <MudText Typo="Typo.h4" Class="mb-1">Welcome back</MudText>
            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">
                Capture todayâ€™s mood and soundtrack.
            </MudText>
        </MudItem>
        <MudItem xs="12" sm="4" Class="d-flex justify-end">
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       Class="mr-2" 
                       StartIcon="@Icons.Material.Filled.AddCircle"
                       OnClick="OpenCreateDialog">
                New Entry
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.CloudUpload" OnClick="ConnectLastFm">
                Connect Last.fm
            </MudButton>
        </MudItem>
    </MudGrid>

    <MudGrid Class="mb-4" Spacing="2">
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Elevation="3" Class="pa-4" Style="background: linear-gradient(135deg,#0ea5e9,#38bdf8); color: #0b1120;">
                <MudText Typo="Typo.caption" Class="mb-1">Mood balance</MudText>
                <MudText Typo="Typo.h5">Valence: +0.12</MudText>
                <MudText Typo="Typo.body2">Averaged last 7 days</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Elevation="3" Class="pa-4" Style="background: linear-gradient(135deg,#a855f7,#c084fc); color: #0b1120;">
                <MudText Typo="Typo.caption" Class="mb-1">Energy trend</MudText>
                <MudText Typo="Typo.h5">Arousal: +0.08</MudText>
                <MudText Typo="Typo.body2">Last 10 sessions</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Elevation="3" Class="pa-4" Style="background: linear-gradient(135deg,#22c55e,#86efac); color: #0b1120;">
                <MudText Typo="Typo.caption" Class="mb-1">Scrobbles</MudText>
                <MudText Typo="Typo.h5">Synced: 0</MudText>
                <MudText Typo="Typo.body2">Connect Last.fm to start</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudGrid Spacing="2">
        <MudItem xs="12" md="7">
            <EntryList @ref="_entryList" OnEditEntry="OpenEditDialog" OnEntryChanged="RefreshData" />
        </MudItem>
        <MudItem xs="12" md="5">
            <MudPaper Elevation="2" Class="pa-4 mb-3">
                <MudText Typo="Typo.h6" Class="mb-2">Quick actions</MudText>
                <MudStack Row Spacing="1">
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth StartIcon="@Icons.Material.Filled.Edit" Disabled>
                        Add mood entry
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" FullWidth StartIcon="@Icons.Material.Filled.AutoGraph" Disabled>
                        View analytics
                    </MudButton>
                    <MudButton Variant="Variant.Text" Color="Color.Error" FullWidth StartIcon="@Icons.Material.Filled.Logout" OnClick="HandleLogout">
                        Logout
                    </MudButton>
                </MudStack>
            </MudPaper>
            <MusicSearchBox />
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private EntryList _entryList = null!;
    [Inject] private ILastFmApiService LastFmApi { get; set; } = null!;
    [Inject] private ISnackbar Snackbar { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        // Check if user is authenticated
        var isAuthenticated = await AuthState.IsAuthenticatedAsync();
        
        if (!isAuthenticated)
        {
            Navigation.NavigateTo("/login");
        }

        // Surface Last.fm connection result via query params
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var queryParams = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        var raw = uri.Query.StartsWith("?") ? uri.Query[1..] : uri.Query;
        foreach (var pair in raw.Split('&', StringSplitOptions.RemoveEmptyEntries))
        {
            var kv = pair.Split('=', 2);
            var key = Uri.UnescapeDataString(kv[0]);
            var value = kv.Length > 1 ? Uri.UnescapeDataString(kv[1]) : string.Empty;
            queryParams[key] = value;
        }
        if (queryParams.TryGetValue("lastfm", out var lastfm))
        {
            if (string.Equals(lastfm, "connected", StringComparison.OrdinalIgnoreCase))
            {
                Snackbar.Add("Last.fm connected successfully", Severity.Success);
            }
            else if (string.Equals(lastfm, "error", StringComparison.OrdinalIgnoreCase))
            {
                var msg = queryParams.TryGetValue("msg", out var m) ? m : "Unknown error";
                Snackbar.Add($"Last.fm connection failed: {msg}", Severity.Error);
            }
        }
    }

    private async Task OpenCreateDialog()
    {
        var dialog = await DialogService.ShowAsync<EntryCreateDialog>("Create new entry");
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            await RefreshData();
        }
    }

    private async Task OpenEditDialog(MIMM.Shared.Dtos.EntryDto entry)
    {
        var parameters = new DialogParameters
        {
            { "EntryId", entry.Id }
        };

        var dialog = await DialogService.ShowAsync<EntryEditDialog>($"Edit: {entry.SongTitle}", parameters);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            await RefreshData();
        }
    }

    private async Task RefreshData()
    {
        await _entryList.LoadEntriesAsync();
    }

    private async Task HandleLogout()
    {
        await AuthState.ClearTokensAsync();
        Navigation.NavigateTo("/login");
    }

    private async Task ConnectLastFm()
    {
        var url = await LastFmApi.GetAuthUrlAsync();
        if (string.IsNullOrWhiteSpace(url))
        {
            Snackbar.Add("Failed to start Last.fm authentication", Severity.Error);
            return;
        }
        // Open auth in new window/tab
        Navigation.NavigateTo(url, true);
    }
}
