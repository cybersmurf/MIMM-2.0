@page "/dashboard"
@using MIMM.Frontend.Services
@using MIMM.Frontend.Components
@using MIMM.Shared.Dtos
@inject IAuthStateService AuthState
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IAnalyticsApiService AnalyticsApi
@inject ILastFmApiService LastFmApi

<PageTitle>Dashboard - MIMM</PageTitle>

<LiveRegion Message="@_liveRegionMessage" AriaLive="polite" />

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6" role="region" aria-label="Dashboard overview">
    <!-- Header Section with Gradient -->
    <div class="dashboard-header">
        <div class="dashboard-header-content">
            <MudText Typo="Typo.h3" Class="dashboard-title text-white">Welcome back ðŸ‘‹</MudText>
            <MudText Typo="Typo.subtitle1" Class="dashboard-subtitle text-white">
                Capture today's mood and soundtrack. Stay connected to your inner music.
            </MudText>
            <div class="dashboard-actions">
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Secondary" 
                           Class="dashboard-action-btn" 
                           StartIcon="@Icons.Material.Filled.AddCircle"
                           Size="Size.Large"
                           OnClick="OpenCreateDialog">
                    New Entry
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                           Color="Color.Tertiary" 
                           Class="dashboard-action-btn" 
                           StartIcon="@Icons.Material.Filled.CloudUpload"
                           Size="Size.Large"
                           OnClick="ConnectLastFm">
                    Connect Last.fm
                </MudButton>
            </div>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="dashboard-stats-grid">
        @if (_isLoadingStats)
        {
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="160px" Class="skeleton-shimmer" />
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="160px" Class="skeleton-shimmer" />
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="160px" Class="skeleton-shimmer" />
        }
        else if (_moodTrend != null)
        {
            <MudPaper Elevation="0" Class="stat-card" Style="background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%); color: white;">
                <div>
                    <MudText Class="stat-card-label">Mood Balance</MudText>
                    <MudText Class="stat-card-value">@_moodTrend.AverageValence.ToString("F1")</MudText>
                </div>
                <MudText Class="stat-card-detail">Valence (averaged last 7 days)</MudText>
            </MudPaper>

            <MudPaper Elevation="0" Class="stat-card" Style="background: linear-gradient(135deg, #a855f7 0%, #d946ef 100%); color: white;">
                <div>
                    <MudText Class="stat-card-label">Energy Trend</MudText>
                    <MudText Class="stat-card-value">@_moodTrend.AverageArousal.ToString("F1")</MudText>
                </div>
                <MudText Class="stat-card-detail">Arousal (last @_moodTrend.TotalEntries sessions)</MudText>
            </MudPaper>

            <MudPaper Elevation="0" Class="stat-card" Style="background: linear-gradient(135deg, #22c55e 0%, #84cc16 100%); color: white;">
                <div>
                    <MudText Class="stat-card-label">Moods Logged</MudText>
                    <MudText Class="stat-card-value">@(_moodTrend?.TotalEntries ?? 0)</MudText>
                </div>
                <MudText Class="stat-card-detail">Mood entries tracked</MudText>
            </MudPaper>
        }
    </div>

    <!-- Main Content Grid -->
    <MudGrid Spacing="3" Class="dashboard-spacing-lg">
        <MudItem xs="12" sm="12" md="8" lg="7">
            <EntryList @ref="_entryList" OnEditEntry="OpenEditDialog" OnEntryChanged="RefreshData" OnCreateFirstEntry="OpenCreateDialog" />
        </MudItem>
        <MudItem xs="12" sm="12" md="4" lg="5">
            <!-- Quick Actions -->
            <MudPaper Elevation="1" Class="quick-actions-panel mb-4">
                <MudText Typo="Typo.h6" Class="mb-4" style="font-weight: 700;">âš¡ Quick Actions</MudText>
                <MudStack Spacing="2">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               FullWidth 
                               Class="quick-action-btn"
                               StartIcon="@Icons.Material.Filled.Edit" 
                               OnClick="OpenCreateDialog">
                        Add Mood Entry
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Primary" 
                               FullWidth 
                               Class="quick-action-btn"
                               StartIcon="@Icons.Material.Filled.TrendingUp" 
                               Href="/analytics">
                        View Analytics
                    </MudButton>
                    <MudButton Variant="Variant.Text" 
                               Color="Color.Secondary" 
                               FullWidth 
                               Class="quick-action-btn"
                               StartIcon="@Icons.Material.Filled.MoreHoriz">
                        More Options
                    </MudButton>
                </MudStack>
            </MudPaper>

            <!-- Music Search -->
            <MudPaper Elevation="1" Class="quick-actions-panel">
                <MudText Typo="Typo.h6" Class="mb-4" style="font-weight: 700;">ðŸŽµ Find Music</MudText>
                <MusicSearchBox />
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private EntryList _entryList = null!;
    private string? _liveRegionMessage;
    
    private bool _isLoadingStats = true;
    private MoodTrendDto? _moodTrend;
    private MusicStatisticsDto? _musicStats;

    protected override async Task OnInitializedAsync()
    {
        var isAuthenticated = await AuthState.IsAuthenticatedAsync();
        
        if (!isAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadStatsAsync();

        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var queryParams = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        var raw = uri.Query.StartsWith("?") ? uri.Query[1..] : uri.Query;
        foreach (var pair in raw.Split('&', StringSplitOptions.RemoveEmptyEntries))
        {
            var kv = pair.Split('=', 2);
            var key = Uri.UnescapeDataString(kv[0]);
            var value = kv.Length > 1 ? Uri.UnescapeDataString(kv[1]) : string.Empty;
            queryParams[key] = value;
        }
        if (queryParams.TryGetValue("lastfm", out var lastfm))
        {
            if (string.Equals(lastfm, "connected", StringComparison.OrdinalIgnoreCase))
            {
                Snackbar.Add("Last.fm connected successfully", Severity.Success);
                await LoadStatsAsync();
            }
            else if (string.Equals(lastfm, "error", StringComparison.OrdinalIgnoreCase))
            {
                var msg = queryParams.TryGetValue("msg", out var m) ? m : "Unknown error";
                Snackbar.Add($"Last.fm connection failed: {msg}", Severity.Error);
            }
        }
    }

    private async Task LoadStatsAsync()
    {
        _isLoadingStats = true;
        _liveRegionMessage = "Loading dashboard statistics...";
        StateHasChanged();

        try
        {
            var moodTask = AnalyticsApi.GetMoodTrendsAsync(daysLookback: 7);
            var musicTask = AnalyticsApi.GetMusicStatisticsAsync();
            await Task.WhenAll(moodTask, musicTask);
            _moodTrend = await moodTask;
            _musicStats = await musicTask;
            _liveRegionMessage = $"Dashboard loaded. {_moodTrend?.TotalEntries ?? 0} mood entries found.";
        }
        catch (Exception ex)
        {
            _liveRegionMessage = "Failed to load statistics. Please try again.";
            Snackbar.Add($"Failed to load statistics: {ex.Message}", Severity.Warning);
            _moodTrend = new MoodTrendDto { AverageValence = 0.0, AverageArousal = 0.0, TotalEntries = 0 };
            _musicStats = null;
        }
        finally
        {
            _isLoadingStats = false;
            StateHasChanged();
        }
    }

    private async Task OpenCreateDialog()
    {
        var dialog = await DialogService.ShowAsync<EntryCreateDialog>("Create new entry");
        var result = await dialog.Result;
        if (result is { Canceled: false }) await RefreshData();
    }

    private async Task OpenEditDialog(MIMM.Shared.Dtos.EntryDto entry)
    {
        var parameters = new DialogParameters { { "EntryId", entry.Id } };
        var dialog = await DialogService.ShowAsync<EntryEditDialog>($"Edit: {entry.SongTitle}", parameters);
        var result = await dialog.Result;
        if (result is { Canceled: false }) await RefreshData();
    }

    private async Task RefreshData()
    {
        await LoadStatsAsync();
        await _entryList.LoadEntriesAsync();
    }

    private async Task HandleLogout()
    {
        await AuthState.ClearTokensAsync();
        Navigation.NavigateTo("/login");
    }

    private async Task ConnectLastFm()
    {
        var url = await LastFmApi.GetAuthUrlAsync();
        if (string.IsNullOrWhiteSpace(url))
        {
            Snackbar.Add("Failed to start Last.fm authentication", Severity.Error);
            return;
        }
        Navigation.NavigateTo(url, true);
    }
}
