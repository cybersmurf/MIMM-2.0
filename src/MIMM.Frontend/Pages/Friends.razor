@page "/friends"
@using MIMM.Frontend.Services
@using MIMM.Shared.Dtos
@inject IFriendsApiService FriendsApi
@inject ISnackbar Snackbar

<PageTitle>Friends - MIMM</PageTitle>

<LiveRegion Message="@_liveMessage" AriaLive="polite" />

<MudContainer MaxWidth="MaxWidth.Large" Class="py-8">
    <MudStack Spacing="4">
        <!-- Page Header -->
        <MudStack Spacing="1">
            <MudText Typo="Typo.h4">Friends</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Connect with other MIMM users and explore shared musical interests.
            </MudText>
        </MudStack>

        <MudGrid Spacing="2">
            <!-- ADD FRIEND SECTION -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="0" Class="glass-card">
                    <MudCardContent>
                        <MudStack Spacing="3">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Color="Color.Primary" Size="Size.Large" />
                                <MudText Typo="Typo.subtitle1">Add a Friend</MudText>
                            </MudStack>

                            <MudTextField 
                                @bind-Value="@_newFriendEmail"
                                Label="Friend's Email"
                                Variant="Variant.Outlined"
                                InputType="InputType.Email"
                                Disabled="@_isAddingFriend"
                                Placeholder="friend@example.com" />

                            <MudButton 
                                Variant="Variant.Filled"
                                Color="Color.Primary"
                                FullWidth
                                OnClick="AddFriendAsync"
                                Disabled="@(_isAddingFriend || string.IsNullOrWhiteSpace(_newFriendEmail))">
                                @if (_isAddingFriend)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate Class="me-2" />
                                    <span>Adding...</span>
                                }
                                else
                                {
                                    <span>Send Friend Request</span>
                                }
                            </MudButton>

                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" />
                                Enter the email address of another MIMM user to add them as a friend.
                            </MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- PENDING REQUESTS SECTION -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="0" Class="glass-card">
                    <MudCardContent>
                        <MudStack Spacing="3">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Inbox" Color="Color.Info" Size="Size.Large" />
                                <MudText Typo="Typo.subtitle1">Pending Requests</MudText>
                                @if (_pendingRequests.Count > 0)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Info">@_pendingRequests.Count</MudChip>
                                }
                            </MudStack>

                            @if (_pendingRequests.Count == 0)
                            {
                                <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="pa-4">
                                    <MudIcon Icon="@Icons.Material.Filled.MarkEmailRead" Color="Color.Secondary" Size="Size.Large" />
                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">
                                        No pending friend requests.
                                    </MudText>
                                </MudStack>
                            }
                            else
                            {
                                <MudStack Spacing="2">
                                    @foreach (var request in _pendingRequests)
                                    {
                                        <MudCard Outlined>
                                            <MudCardContent>
                                                <MudStack Spacing="2">
                                                    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                                    <MudAvatar Color="Color.Primary">@(request.FriendDisplayName?.FirstOrDefault() ?? 'U')</MudAvatar>
                                                        <MudStack Spacing="0">
                                                            <MudText Typo="Typo.body2">@request.FriendDisplayName</MudText>
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">@request.FriendEmail</MudText>
                                                        </MudStack>
                                                    </MudStack>
                                                    <MudStack Row Spacing="1">
                                                        <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Success" 
                                                                   OnClick="@(async () => await RespondRequestAsync(request.Id, "accept"))">
                                                            <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Class="me-1" />
                                                            Accept
                                                        </MudButton>
                                                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Error" 
                                                                   OnClick="@(async () => await RespondRequestAsync(request.Id, "reject"))">
                                                            <MudIcon Icon="@Icons.Material.Filled.Close" Size="Size.Small" Class="me-1" />
                                                            Reject
                                                        </MudButton>
                                                    </MudStack>
                                                </MudStack>
                                            </MudCardContent>
                                        </MudCard>
                                    }
                                </MudStack>
                            }
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- FRIENDS LIST SECTION -->
        <MudCard Elevation="0" Class="glass-card">
            <MudCardContent>
                <MudStack Spacing="3">
                    <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Group" Color="Color.Success" Size="Size.Large" />
                        <MudText Typo="Typo.subtitle1">My Friends</MudText>
                        @if (_friends.Count > 0)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Success">@_friends.Count</MudChip>
                        }
                    </MudStack>

                    @if (_isLoadingFriends)
                    {
                        <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="pa-6">
                            <MudProgressCircular Indeterminate />
                            <MudText Typo="Typo.caption">Loading friends...</MudText>
                        </MudStack>
                    }
                    else if (_friends.Count == 0)
                    {
                        <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="pa-6">
                            <MudIcon Icon="@Icons.Material.Filled.GroupAdd" Color="Color.Secondary" Size="Size.Large" />
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">
                                You haven't added any friends yet.
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">
                                Add your first friend to get started!
                            </MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudGrid Spacing="2">
                            @foreach (var friend in _friends)
                            {
                                <MudItem xs="12" sm="6" md="4">
                                    <MudCard Outlined>
                                        <MudCardContent>
                                            <MudStack Spacing="2">
                                                <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                                    <MudAvatar Color="Color.Primary" Size="Size.Medium">@(friend.FriendDisplayName?.FirstOrDefault() ?? 'U')</MudAvatar>
                                                    <MudStack Spacing="0" Style="flex: 1;">
                                                        <MudText Typo="Typo.body1">@friend.FriendDisplayName</MudText>
                                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@friend.FriendEmail</MudText>
                                                    </MudStack>
                                                </MudStack>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" Class="me-1" />
                                                    Since @friend.ConnectedSince.ToString("MMM dd, yyyy")
                                                </MudText>
                                                <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Error" 
                                                           FullWidth
                                                           OnClick="@(async () => await RemoveFriendAsync(friend.Id))">
                                                    <MudIcon Icon="@Icons.Material.Filled.PersonRemove" Size="Size.Small" Class="me-1" />
                                                    Remove
                                                </MudButton>
                                            </MudStack>
                                        </MudCardContent>
                                    </MudCard>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                </MudStack>
            </MudCardContent>
        </MudCard>
    </MudStack>
</MudContainer>

@code {
    private List<FriendDto> _friends = [];
    private List<FriendDto> _pendingRequests = [];
    private string? _newFriendEmail;
    private string? _liveMessage;
    private bool _isLoadingFriends = true;
    private bool _isAddingFriend = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadFriendsAsync();
        await LoadPendingRequestsAsync();
    }

    private async Task LoadFriendsAsync()
    {
        _isLoadingFriends = true;
        try
        {
            var result = await FriendsApi.GetFriendsAsync();
            _friends = result.Friends ?? [];
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading friends: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoadingFriends = false;
        }
    }

    private async Task LoadPendingRequestsAsync()
    {
        try
        {
            _pendingRequests = await FriendsApi.GetPendingRequestsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading pending requests: {ex.Message}", Severity.Error);
        }
    }

    private async Task AddFriendAsync()
    {
        if (string.IsNullOrWhiteSpace(_newFriendEmail))
            return;

        _isAddingFriend = true;
        try
        {
            var result = await FriendsApi.AddFriendAsync(_newFriendEmail);
            if (result.Success)
            {
                Snackbar.Add("Friend added successfully!", Severity.Success);
                _newFriendEmail = null;
                await LoadFriendsAsync();
            }
            else
            {
                Snackbar.Add(result.Message ?? "Failed to add friend", Severity.Error);
            }
        }
        finally
        {
            _isAddingFriend = false;
        }
    }

    private async Task RemoveFriendAsync(Guid friendshipId)
    {
        try
        {
            var result = await FriendsApi.RemoveFriendAsync(friendshipId);
            if (result.Success)
            {
                Snackbar.Add("Friend removed", Severity.Success);
                await LoadFriendsAsync();
            }
            else
            {
                Snackbar.Add(result.Message ?? "Failed to remove friend", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error removing friend: {ex.Message}", Severity.Error);
        }
    }

    private async Task RespondRequestAsync(Guid friendshipId, string action)
    {
        try
        {
            var result = await FriendsApi.RespondFriendRequestAsync(friendshipId, action);
            if (result.Success)
            {
                Snackbar.Add($"Friend request {action}ed", Severity.Success);
                if (action == "accept")
                    await LoadFriendsAsync();
                
                await LoadPendingRequestsAsync();
            }
            else
            {
                Snackbar.Add(result.Message ?? "Failed to respond to request", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error responding to request: {ex.Message}", Severity.Error);
        }
    }
}

<style>
.glass-card {
    background: rgba(255, 255, 255, 0.05) !important;
    backdrop-filter: blur(10px) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 12px !important;
}
</style>
