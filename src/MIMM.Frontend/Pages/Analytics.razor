@page "/analytics"
@using MIMM.Shared.Dtos
@using MIMM.Frontend.Services
@using MudBlazor.Charts

@inject IAnalyticsApiService AnalyticsApi
@inject ISnackbar Snackbar
@inject IAuthStateService AuthState
@inject NavigationManager NavigationManager

<PageTitle>Analytics - MIMM</PageTitle>

<LiveRegion Message="@_liveMessage" AriaLive="polite" />

<MudContainer MaxWidth="MaxWidth.Large" Class="py-8">
    <MudStack Spacing="4">
        <!-- Page Header -->
        <MudStack Spacing="1">
            <MudText Typo="Typo.h4">Analytics</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Track your mood trends and music preferences</MudText>
        </MudStack>

        <!-- Summary Cards -->
        <MudGrid Spacing="2">
            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="0" Class="glass-card card-hover-subtle">
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.LibraryMusic" Color="Color.Primary" Size="Size.Large" />
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.caption">Total Entries</MudText>
                                @if (_isLoading)
                                {
                                    <MudSkeleton Width="100px" Height="32px" Class="skeleton-shimmer" />
                                }
                                else
                                {
                                    <MudText Typo="Typo.h5">@_totalEntries</MudText>
                                }
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="0" Class="glass-card card-hover-subtle">
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.ElectricBolt" Color="Color.Warning" Size="Size.Large" />
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.caption">Avg. Arousal</MudText>
                                @if (_isLoading)
                                {
                                    <MudSkeleton Width="100px" Height="32px" Class="skeleton-shimmer" />
                                }
                                else
                                {
                                    <MudText Typo="Typo.h5">@_avgArousal.ToString("F1")</MudText>
                                }
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="0" Class="glass-card card-hover-subtle">
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.SentimentSatisfied" Color="Color.Success" Size="Size.Large" />
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.caption">Avg. Valence</MudText>
                                @if (_isLoading)
                                {
                                    <MudSkeleton Width="100px" Height="32px" Class="skeleton-shimmer" />
                                }
                                else
                                {
                                    <MudText Typo="Typo.h5">@_avgValence.ToString("F1")</MudText>
                                }
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="0" Class="glass-card card-hover-subtle">
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.MusicNote" Color="Color.Info" Size="Size.Large" />
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.caption">Top Genre</MudText>
                                @if (_isLoading)
                                {
                                    <MudSkeleton Width="100px" Height="32px" />
                                }
                                else
                                {
                                    <MudText Typo="Typo.h5">@(_topGenre ?? "â€”")</MudText>
                                }
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- Data Loaded Section -->
        @if (!_isLoading && _trends != null)
        {
            <MudGrid Spacing="3">
                <!-- Mood Distribution Pie Chart -->
                <MudItem xs="12" sm="12" md="6" lg="6">
                    <MudCard Elevation="0" Class="glass-card">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudText Typo="Typo.subtitle1">Mood Distribution (Quadrants)</MudText>
                                @if (_isLoading)
                                {
                                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="300px" Class="skeleton-shimmer" />
                                }
                                else if (_moodDistributionData.Count > 0)
                                {
                                    <MudChart ChartType="ChartType.Pie" 
                                              ChartSeries="@_moodDistributionSeries" 
                                              ChartOptions="@_moodDistributionOptions"
                                              Width="100%"
                                              Height="300px"
                                              Class="pa-3" />
                                }
                                else
                                {
                                    <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="pa-6">
                                        <MudIcon Icon="@Icons.Material.Filled.DonutSmall" Color="Color.Default" Size="Size.Large" />
                                        <MudText Typo="Typo.body2" Align="Align.Center">
                                            No mood distribution data available
                                        </MudText>
                                        <MudText Typo="Typo.caption" Align="Align.Center">
                                            Create entries to see your emotional patterns
                                        </MudText>
                                    </MudStack>
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <!-- Top Artists Bar Chart -->
                <MudItem xs="12" sm="12" md="6" lg="6">
                    <MudCard Elevation="0" Class="glass-card">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudText Typo="Typo.subtitle1">Top Artists (Last 30 days)</MudText>
                                @if (_isLoading)
                                {
                                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="300px" Class="skeleton-shimmer" />
                                }
                                else if (_topArtistsData.Count > 0)
                                {
                                    <MudChart ChartType="ChartType.Bar" 
                                              ChartSeries="@_topArtistsSeries" 
                                              ChartOptions="@_topArtistsOptions"
                                              XAxisLabels="@_topArtistsLabels.ToArray()"
                                              Width="100%"
                                              Height="300px"
                                              Class="pa-3" />
                                }
                                else
                                {
                                    <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="pa-6">
                                        <MudIcon Icon="@Icons.Material.Filled.Person" Color="Color.Default" Size="Size.Large" />
                                        <MudText Typo="Typo.body2" Align="Align.Center">
                                            No artist data available
                                        </MudText>
                                        <MudText Typo="Typo.caption" Align="Align.Center">
                                            Start scrobbling music to track your top artists
                                        </MudText>
                                    </MudStack>
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <!-- Mood Trends Line Chart -->
                <MudItem xs="12">
                    <MudCard Elevation="0" Class="glass-card">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudText Typo="Typo.subtitle1">Mood Trends (Last 30 days)</MudText>
                                @if (_isLoading)
                                {
                                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="400px" Class="skeleton-shimmer" />
                                }
                                else if (_moodTrendsData.Count > 0)
                                {
                                    <MudChart ChartType="ChartType.Line" 
                                              ChartSeries="@_moodTrendsSeries" 
                                              ChartOptions="@_moodTrendsOptions"
                                              XAxisLabels="@_trendLabels.ToArray()"
                                              Width="100%"
                                              Height="400px"
                                              Class="pa-3" />
                                }
                                else
                                {
                                    <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="pa-6">
                                        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Color="Color.Default" Size="Size.Large" />
                                        <MudText Typo="Typo.body2" Align="Align.Center">
                                            No mood trend data available
                                        </MudText>
                                        <MudText Typo="Typo.caption" Align="Align.Center">
                                            Track your moods over time to see trends emerge
                                        </MudText>
                                    </MudStack>
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>

            <!-- Advanced Analytics Section -->
            <MudDivider Class="mt-4 mb-4" />

            <MudStack Spacing="2">
                <MudText Typo="Typo.h6">Advanced Analytics</MudText>
                
                <!-- Yearly Report -->
                <MudCard Elevation="0" Class="glass-card">
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudText Typo="Typo.subtitle1">Annual Reports</MudText>
                                <MudSpacer />
                                <MudSelect T="int" @bind-Value="_selectedYear" Label="Year" Dense>
                                    @for (int year = DateTime.Now.Year; year >= DateTime.Now.Year - 4; year--)
                                    {
                                        <MudSelectItem Value="@year">@year</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudStack>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                View detailed annual statistics including monthly breakdown, top artists, and mood distribution
                            </MudText>
                            <MudButton Variant="Variant.Outlined" OnClick="@(() => ViewYearlyReportAsync())" FullWidth StartIcon="@Icons.Material.Filled.BarChart">
                                View @_selectedYear Report
                            </MudButton>
                        </MudStack>
                    </MudCardContent>
                </MudCard>

                <!-- Mood by Artist Analysis -->
                <MudCard Elevation="0" Class="glass-card">
                    <MudCardContent>
                        <MudStack Spacing="2">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                <MudText Typo="Typo.subtitle1">Mood by Artist</MudText>
                                <MudSpacer />
                                @if (_moodCorrelationLoading)
                                {
                                    <MudProgressCircular Indeterminate Size="Size.Small" />
                                }
                                else
                                {
                                    <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Refresh" OnClick="@LoadMoodCorrelationAsync">
                                        Refresh
                                    </MudButton>
                                }
                            </MudStack>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Analyze how your mood correlates with different artists and music sources
                            </MudText>

                            @if (_moodCorrelation != null && (_moodCorrelation.ArtistMoods?.Count > 0 || _moodCorrelation.SourceMoods?.Count > 0))
                            {
                                <MudTabs>
                                    <!-- Artists Tab -->
                                    @if (_moodCorrelation.ArtistMoods?.Count > 0)
                                    {
                                        <MudTabPanel Text="By Artist">
                                            <MudList T="ArtistMoodDto" Dense>
                                                @foreach (var artist in _moodCorrelation.ArtistMoods.Take(15))
                                                {
                                                    <MudListItem T="ArtistMoodDto">
                                                        <MudStack Row AlignItems="AlignItems.Center" Spacing="2" Style="width: 100%;">
                                                            <MudText Typo="Typo.body2" Style="min-width: 200px;">@artist.Artist</MudText>
                                                            <MudStack Row Spacing="1" Class="flex-wrap" Style="flex: 1;">
                                                                <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.LibraryMusic">
                                                                    @artist.EntryCount
                                                                </MudChip>
                                                                <MudChip T="string" Size="Size.Small" Color="Color.Success">
                                                                    Valence: @artist.AverageValence.ToString("F2")
                                                                </MudChip>
                                                                <MudChip T="string" Size="Size.Small" Color="Color.Warning">
                                                                    Energy: @artist.AverageArousal.ToString("F2")
                                                                </MudChip>
                                                            </MudStack>
                                                        </MudStack>
                                                    </MudListItem>
                                                }
                                            </MudList>
                                        </MudTabPanel>
                                    }

                                    <!-- Sources Tab -->
                                    @if (_moodCorrelation.SourceMoods?.Count > 0)
                                    {
                                        <MudTabPanel Text="By Source">
                                            <MudList T="SourceMoodDto" Dense>
                                                @foreach (var source in _moodCorrelation.SourceMoods)
                                                {
                                                    <MudListItem T="SourceMoodDto">
                                                        <MudStack Row AlignItems="AlignItems.Center" Spacing="2" Style="width: 100%;">
                                                            <MudText Typo="Typo.body2" Style="min-width: 200px;">@source.Source</MudText>
                                                            <MudStack Row Spacing="1" Style="flex: 1;">
                                                                <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.LibraryMusic">
                                                                    @source.EntryCount
                                                                </MudChip>
                                                                <MudChip T="string" Size="Size.Small" Color="Color.Success">
                                                                    Valence: @source.AverageValence.ToString("F2")
                                                                </MudChip>
                                                                <MudChip T="string" Size="Size.Small" Color="Color.Warning">
                                                                    Energy: @source.AverageArousal.ToString("F2")
                                                                </MudChip>
                                                            </MudStack>
                                                        </MudStack>
                                                    </MudListItem>
                                                }
                                            </MudList>
                                        </MudTabPanel>
                                    }
                                </MudTabs>
                            }
                            else if (!_moodCorrelationLoading)
                            {
                                <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="pa-6">
                                    <MudIcon Icon="@Icons.Material.Filled.InsertChart" Color="Color.Default" Size="Size.Large" />
                                    <MudText Typo="Typo.body2" Align="Align.Center">
                                        No mood correlation data available. Create more entries to see patterns.
                                    </MudText>
                                </MudStack>
                            }
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudStack>
        }
        else if (!_isLoading)
        {
            <MudAlert Severity="Severity.Info">No mood entries yet. Create your first entry to see analytics.</MudAlert>
        }
    </MudStack>
</MudContainer>

@code {
    private bool _isLoading = true;
    private string? _liveMessage;
    private int _totalEntries;
    private double _avgValence;
    private int _selectedYear = DateTime.Now.Year;
    private bool _moodCorrelationLoading;
    private MoodCorrelationDto? _moodCorrelation;

    private double _avgArousal;
    private string? _topGenre;

    private MoodTrendDto? _trends;
    private List<ArtistStatDto> _topArtists = [];
    private Dictionary<string, int> _quadrants = new()
    {
        { "energetic", 0 },
        { "calm", 0 },
        { "sad", 0 },
        { "angry", 0 }
    };

    // Chart Data
    private List<double> _moodDistributionData = [];
    private List<ChartSeries> _moodDistributionSeries = [];
    private ChartOptions _moodDistributionOptions = new();

    private List<double> _moodTrendsData = [];
    private List<ChartSeries> _moodTrendsSeries = [];
    private List<string> _trendLabels = [];
    private ChartOptions _moodTrendsOptions = new();

    private List<double> _topArtistsData = [];
    private List<ChartSeries> _topArtistsSeries = [];
    private List<string> _topArtistsLabels = [];
    private ChartOptions _topArtistsOptions = new();

    protected override async Task OnInitializedAsync()
    {
        var isAuthenticated = await AuthState.IsAuthenticatedAsync();
        if (!isAuthenticated)
        {
            return;
        }

        await LoadAnalyticsDataAsync();
    }

    private async Task LoadAnalyticsDataAsync()
    {
        try
        {
            _isLoading = true;
            _liveMessage = "Loading analytics data...";

            // Fetch trends and stats
            _trends = await AnalyticsApi.GetMoodTrendsAsync(30);
            var stats = await AnalyticsApi.GetMusicStatisticsAsync();

            // Calculate summary metrics
            if (_trends is not null && _trends.DailyAverages?.Any() == true)
            {
                _totalEntries = _trends.TotalEntries;
                _avgValence = _trends.AverageValence;
                _avgArousal = _trends.AverageArousal;

                // Calculate mood quadrants from distribution
                if (_trends.MoodDistribution is not null)
                {
                    _quadrants["energetic"] = (int)(_trends.MoodDistribution.HappyPercent / 100 * _totalEntries);
                    _quadrants["calm"] = (int)(_trends.MoodDistribution.CalmPercent / 100 * _totalEntries);
                    _quadrants["sad"] = (int)(_trends.MoodDistribution.SadPercent / 100 * _totalEntries);
                    _quadrants["angry"] = (int)(_trends.MoodDistribution.AngryPercent / 100 * _totalEntries);
                }
            }

            if (stats is not null && stats.TopArtists?.Any() == true)
            {
                _topGenre = stats.TopArtists.FirstOrDefault()?.Name;
                _topArtists = stats.TopArtists;
            }

            // Initialize charts
            InitializeMoodDistributionChart();
            InitializeMoodTrendsChart();
            InitializeTopArtistsChart();

            _liveMessage = "Analytics loaded successfully.";
        }
        catch (Exception ex)
        {
            _liveMessage = "Failed to load analytics.";
            Snackbar.Add($"Failed to load analytics: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void InitializeMoodDistributionChart()
    {
        if (_trends?.MoodDistribution == null)
            return;

        _moodDistributionData =
        [
            _trends.MoodDistribution.HappyPercent,
            _trends.MoodDistribution.CalmPercent,
            _trends.MoodDistribution.SadPercent,
            _trends.MoodDistribution.AngryPercent
        ];

        _moodDistributionSeries =
        [
            new ChartSeries { Name = "Mood Distribution", Data = _moodDistributionData.ToArray() }
        ];

        _moodDistributionOptions = new ChartOptions
        {
            ChartPalette =
            [
                "#ff5722", // Energetic (orange)
                "#4caf50", // Calm (green)
                "#2196f3", // Sad (blue)
                "#f44336"  // Angry (red)
            ],
            YAxisTicks = 10
        };
    }

    private void InitializeMoodTrendsChart()
    {
        if (_trends?.DailyAverages == null || !_trends.DailyAverages.Any())
            return;

        var sortedDaily = _trends.DailyAverages.OrderBy(d => d.Date).ToList();
        
        var valenceData = sortedDaily.Select(d => (double)d.AverageValence).ToList();
        var arousalData = sortedDaily.Select(d => (double)d.AverageArousal).ToList();

        _trendLabels = sortedDaily.Select(d => d.Date.ToString("MMM dd")).ToList();

        _moodTrendsSeries =
        [
            new ChartSeries { Name = "Valence (Positivity)", Data = valenceData.ToArray() },
            new ChartSeries { Name = "Arousal (Energy)", Data = arousalData.ToArray() }
        ];

        _moodTrendsOptions = new ChartOptions
        {
            ChartPalette = ["#3b82f6", "#a855f7"],
            YAxisTicks = 5
        };
    }

    private void InitializeTopArtistsChart()
    {
        if (_topArtists == null || !_topArtists.Any())
            return;

        var topFive = _topArtists.Take(5).ToList();
        _topArtistsLabels = topFive.Select(a => a.Name).ToList();
        _topArtistsData = topFive.Select(a => (double)a.Count).ToList();

        _topArtistsSeries =
        [
            new ChartSeries { Name = "Play Count", Data = _topArtistsData.ToArray() }
        ];

        _topArtistsOptions = new ChartOptions
        {
            ChartPalette = ["#9333ea"],
            YAxisTicks = 5
        };
    }

    private async Task LoadMoodCorrelationAsync()
    {
        try
        {
            _moodCorrelationLoading = true;
            _moodCorrelation = await AnalyticsApi.GetMoodByArtistAsync();

            if (_moodCorrelation == null)
            {
                Snackbar.Add("Failed to load mood correlation data", Severity.Error);
            }
        }
        catch (UnauthorizedAccessException)
        {
            Snackbar.Add("Authentication required", Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading mood correlation: {ex.Message}", Severity.Error);
            Console.Error.WriteLine($"Error: {ex}");
        }
        finally
        {
            _moodCorrelationLoading = false;
        }
    }

    private async Task ViewYearlyReportAsync()
    {
        // Navigate to yearly report page
        // NavigationManager.NavigateTo($"/analytics/yearly/{_selectedYear}");
        // For now, load and show the data in a dialog
        var report = await AnalyticsApi.GetYearlyReportAsync(_selectedYear);
        if (report != null)
        {
            Snackbar.Add($"Loaded {_selectedYear} annual report with {report.TotalEntries} entries", Severity.Success);
        }
        else
        {
            Snackbar.Add($"No data available for {_selectedYear}", Severity.Warning);
        }
    }
}

<style>
.glass-card {
    background: rgba(255, 255, 255, 0.05) !important;
    backdrop-filter: blur(10px) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 12px !important;
}
</style>
